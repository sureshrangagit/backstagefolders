{"version":3,"file":"gitlabPipelineTrigger.cjs.js","sources":["../../src/actions/gitlabPipelineTrigger.ts"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { InputError } from '@backstage/errors';\nimport { ScmIntegrationRegistry } from '@backstage/integration';\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport {\n  ExpandedPipelineSchema,\n  PipelineTriggerTokenSchema,\n} from '@gitbeaker/rest';\nimport { getClient, parseRepoUrl } from '../util';\nimport { examples } from './gitlabPipelineTrigger.examples';\nimport { getErrorMessage } from './helpers';\n\n/**\n * Creates a `gitlab:pipeline:trigger` Scaffolder action.\n *\n * @param options - Templating configuration.\n * @public\n */\nexport const createTriggerGitlabPipelineAction = (options: {\n  integrations: ScmIntegrationRegistry;\n}) => {\n  const { integrations } = options;\n  return createTemplateAction({\n    id: 'gitlab:pipeline:trigger',\n    description: 'Triggers a GitLab Pipeline.',\n    examples,\n    schema: {\n      input: {\n        repoUrl: z =>\n          z.string({\n            description: `Accepts the format 'gitlab.com?repo=project_name&owner=group_name' where 'project_name' is the repository name and 'group_name' is a group or username`,\n          }),\n        token: z =>\n          z\n            .string({\n              description: 'The token to use for authorization to GitLab',\n            })\n            .optional(),\n        projectId: z =>\n          z.number({\n            description: 'Project Id',\n          }),\n        tokenDescription: z =>\n          z.string({\n            description: 'Pipeline token description',\n          }),\n        branch: z =>\n          z.string({\n            description: 'Project branch',\n          }),\n        variables: z =>\n          z\n            .record(z.string(), z.string(), {\n              description:\n                'A object/record of key-valued strings containing the pipeline variables.',\n            })\n            .optional(),\n      },\n      output: {\n        pipelineUrl: z =>\n          z.string({\n            description: 'Pipeline Url',\n          }),\n      },\n    },\n    async handler(ctx) {\n      let pipelineTriggerToken: string | undefined = undefined;\n      let pipelineTriggerId: number | undefined = undefined;\n\n      const { repoUrl, projectId, tokenDescription, token, branch, variables } =\n        ctx.input;\n\n      const { host } = parseRepoUrl(repoUrl, integrations);\n      const api = getClient({ host, integrations, token });\n\n      try {\n        ({ pipelineTriggerToken, pipelineTriggerId } = await ctx.checkpoint({\n          key: `create.pipeline.token.${projectId}`,\n          fn: async () => {\n            const res = (await api.PipelineTriggerTokens.create(\n              projectId,\n              tokenDescription,\n            )) as PipelineTriggerTokenSchema;\n            return {\n              pipelineTriggerToken: res.token,\n              pipelineTriggerId: res.id,\n            };\n          },\n        }));\n\n        if (!pipelineTriggerToken) {\n          ctx.logger.error(\n            `Failed to create pipeline token for project ${projectId}.`,\n          );\n          return;\n        }\n        ctx.logger.info(\n          `Pipeline token id ${pipelineTriggerId} created for project ${projectId}.`,\n        );\n\n        // Use the pipeline token to trigger the pipeline in the project\n        const pipelineTriggerResponse =\n          (await api.PipelineTriggerTokens.trigger(\n            projectId,\n            branch,\n            pipelineTriggerToken,\n            { variables },\n          )) as ExpandedPipelineSchema;\n\n        if (!pipelineTriggerResponse.id) {\n          ctx.logger.error(\n            `Failed to trigger pipeline for project ${projectId}.`,\n          );\n          return;\n        }\n\n        ctx.logger.info(\n          `Pipeline id ${pipelineTriggerResponse.id} for project ${projectId} triggered.`,\n        );\n\n        ctx.output('pipelineUrl', pipelineTriggerResponse.web_url);\n      } catch (error: any) {\n        // Handling other errors\n        throw new InputError(\n          `Failed to trigger Pipeline: ${getErrorMessage(error)}`,\n        );\n      } finally {\n        // Delete the pipeline token if it was created\n        if (pipelineTriggerId) {\n          try {\n            await ctx.checkpoint({\n              key: `create.delete.token.${projectId}`,\n              fn: async () => {\n                if (pipelineTriggerId) {\n                  // to make the current version of TypeScript happy\n                  await api.PipelineTriggerTokens.remove(\n                    projectId,\n                    pipelineTriggerId,\n                  );\n                }\n              },\n            });\n            ctx.logger.info(\n              `Deleted pipeline with token id ${pipelineTriggerId}.`,\n            );\n          } catch (error: any) {\n            ctx.logger.error(\n              `Failed to delete pipeline with token id ${pipelineTriggerId}.`,\n            );\n          }\n        }\n      }\n    },\n  });\n};\n"],"names":["createTemplateAction","examples","parseRepoUrl","getClient","InputError","getErrorMessage"],"mappings":"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"}