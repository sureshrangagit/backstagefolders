{"version":3,"file":"ManagedIdentityClientAssertion.esm.js","sources":["../../src/azure/ManagedIdentityClientAssertion.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ManagedIdentityCredential } from '@azure/identity';\nimport { ClientAssertion } from './ClientAssertion';\n\nexport type ManagedIdentityClientAssertionOptions = {\n  clientId?: string;\n};\n\nconst fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds\nconst expiresWithinFiveMinutes = (clientAssertion: ClientAssertion) =>\n  clientAssertion.expiresOnTimestamp - Date.now() <= fiveMinutes;\n\n/**\n * Class representing a Managed Identity Client Assertion.\n * This class is responsible for obtaining a signed client assertion using Azure Managed Identity.\n */\nexport class ManagedIdentityClientAssertion {\n  private credential: ManagedIdentityCredential;\n  private clientAssertion?: ClientAssertion;\n\n  /**\n   * Creates an instance of ManagedIdentityClientAssertion.\n   * @param options - Optional parameters for the ManagedIdentityClientAssertion.\n   *                  - clientId: The client ID of the managed identity. If not provided, 'system-assigned' is used.\n   */\n  constructor(options?: ManagedIdentityClientAssertionOptions) {\n    let { clientId } = options || {};\n    clientId ??= 'system-assigned';\n\n    this.credential =\n      clientId === 'system-assigned'\n        ? new ManagedIdentityCredential()\n        : new ManagedIdentityCredential(clientId);\n  }\n\n  /**\n   * Gets a signed client assertion.\n   * If a valid client assertion is already cached which doesn't expire soon, it returns the cached assertion.\n   * Otherwise, it obtains a new access token and creates a new client assertion.\n   * @returns A promise that resolves to the signed client assertion.\n   */\n  public async getSignedAssertion(): Promise<string> {\n    if (\n      this.clientAssertion !== undefined &&\n      !expiresWithinFiveMinutes(this.clientAssertion)\n    ) {\n      return this.clientAssertion.signedAssertion;\n    }\n\n    const accessToken = await this.credential.getToken(\n      'api://AzureADTokenExchange',\n    );\n\n    this.clientAssertion = {\n      signedAssertion: accessToken.token,\n      expiresOnTimestamp: accessToken.expiresOnTimestamp,\n    };\n\n    return accessToken.token;\n  }\n}\n"],"names":[],"mappings":";;AAsBA,MAAM,WAAA,GAAc,IAAI,EAAK,GAAA,GAAA;AAC7B,MAAM,2BAA2B,CAAC,eAAA,KAChC,gBAAgB,kBAAqB,GAAA,IAAA,CAAK,KAAS,IAAA,WAAA;AAM9C,MAAM,8BAA+B,CAAA;AAAA,EAClC,UAAA;AAAA,EACA,eAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOR,YAAY,OAAiD,EAAA;AAC3D,IAAA,IAAI,EAAE,QAAA,EAAa,GAAA,OAAA,IAAW,EAAC;AAC/B,IAAa,QAAA,KAAA,iBAAA;AAEb,IAAK,IAAA,CAAA,UAAA,GACH,aAAa,iBACT,GAAA,IAAI,2BACJ,GAAA,IAAI,0BAA0B,QAAQ,CAAA;AAAA;AAC9C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQA,MAAa,kBAAsC,GAAA;AACjD,IAAA,IACE,KAAK,eAAoB,KAAA,KAAA,CAAA,IACzB,CAAC,wBAAyB,CAAA,IAAA,CAAK,eAAe,CAC9C,EAAA;AACA,MAAA,OAAO,KAAK,eAAgB,CAAA,eAAA;AAAA;AAG9B,IAAM,MAAA,WAAA,GAAc,MAAM,IAAA,CAAK,UAAW,CAAA,QAAA;AAAA,MACxC;AAAA,KACF;AAEA,IAAA,IAAA,CAAK,eAAkB,GAAA;AAAA,MACrB,iBAAiB,WAAY,CAAA,KAAA;AAAA,MAC7B,oBAAoB,WAAY,CAAA;AAAA,KAClC;AAEA,IAAA,OAAO,WAAY,CAAA,KAAA;AAAA;AAEvB;;;;"}