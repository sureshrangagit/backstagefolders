{"version":3,"file":"convertLegacyAppOptions.esm.js","sources":["../src/convertLegacyAppOptions.tsx"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ComponentType } from 'react';\nimport {\n  ApiBlueprint,\n  coreComponentRefs,\n  CoreErrorBoundaryFallbackProps,\n  createComponentExtension,\n  createExtension,\n  createFrontendModule,\n  ExtensionDefinition,\n  FrontendModule,\n  IconBundleBlueprint,\n  RouterBlueprint,\n  SignInPageBlueprint,\n  ThemeBlueprint,\n} from '@backstage/frontend-plugin-api';\nimport {\n  AnyApiFactory,\n  AppComponents,\n  AppTheme,\n  BackstagePlugin,\n  FeatureFlag,\n  IconComponent,\n} from '@backstage/core-plugin-api';\nimport { toLegacyPlugin } from './compatWrapper/BackwardsCompatProvider';\nimport { compatWrapper } from './compatWrapper';\n\nfunction componentCompatWrapper<TProps extends {}>(\n  Component: ComponentType<TProps>,\n) {\n  return (props: TProps) => compatWrapper(<Component {...props} />);\n}\n\n/**\n * @public\n */\nexport function convertLegacyAppOptions(\n  options: {\n    apis?: Iterable<AnyApiFactory>;\n\n    icons?: { [key in string]: IconComponent };\n\n    plugins?: Array<BackstagePlugin>;\n\n    components?: Partial<AppComponents>;\n\n    themes?: AppTheme[];\n\n    featureFlags?: (FeatureFlag & Omit<FeatureFlag, 'pluginId'>)[];\n  } = {},\n): FrontendModule {\n  const { apis, icons, plugins, components, themes, featureFlags } = options;\n\n  const allApis = [\n    ...(plugins?.flatMap(plugin => [...plugin.getApis()]) ?? []),\n    ...(apis ?? []),\n  ];\n  const deduplicatedApis = Array.from(\n    new Map(allApis.map(api => [api.api.id, api])).values(),\n  );\n  const extensions: ExtensionDefinition[] = deduplicatedApis.map(factory =>\n    ApiBlueprint.make({ name: factory.api.id, params: { factory } }),\n  );\n\n  if (icons) {\n    extensions.push(\n      IconBundleBlueprint.make({\n        name: 'app-options',\n        params: { icons },\n      }),\n    );\n  }\n\n  if (themes) {\n    // IF any themes are provided we need to disable the default ones, unless they are overridden\n    for (const id of ['light', 'dark']) {\n      if (!themes.some(theme => theme.id === id)) {\n        extensions.push(\n          createExtension({\n            kind: 'theme',\n            name: id,\n            attachTo: { id: 'api:app/app-theme', input: 'themes' },\n            disabled: true,\n            output: [],\n            factory: () => [],\n          }),\n        );\n      }\n    }\n    extensions.push(\n      ...themes.map(theme =>\n        ThemeBlueprint.make({\n          name: theme.id,\n          params: { theme },\n        }),\n      ),\n    );\n  }\n\n  if (components) {\n    const {\n      BootErrorPage,\n      ErrorBoundaryFallback,\n      NotFoundErrorPage,\n      Progress,\n      Router,\n      SignInPage,\n      ThemeProvider,\n    } = components;\n\n    if (BootErrorPage) {\n      throw new Error(\n        'components.BootErrorPage is not supported by convertLegacyAppOptions',\n      );\n    }\n    if (ThemeProvider) {\n      throw new Error(\n        'components.ThemeProvider is not supported by convertLegacyAppOptions',\n      );\n    }\n    if (Router) {\n      extensions.push(\n        RouterBlueprint.make({\n          params: { Component: componentCompatWrapper(Router) },\n        }),\n      );\n    }\n    if (SignInPage) {\n      extensions.push(\n        SignInPageBlueprint.make({\n          params: {\n            loader: () => Promise.resolve(componentCompatWrapper(SignInPage)),\n          },\n        }),\n      );\n    }\n    if (Progress) {\n      extensions.push(\n        createComponentExtension({\n          ref: coreComponentRefs.progress,\n          loader: { sync: () => componentCompatWrapper(Progress) },\n        }),\n      );\n    }\n    if (NotFoundErrorPage) {\n      extensions.push(\n        createComponentExtension({\n          ref: coreComponentRefs.notFoundErrorPage,\n          loader: { sync: () => componentCompatWrapper(NotFoundErrorPage) },\n        }),\n      );\n    }\n    if (ErrorBoundaryFallback) {\n      const WrappedErrorBoundaryFallback = (\n        props: CoreErrorBoundaryFallbackProps,\n      ) =>\n        compatWrapper(\n          <ErrorBoundaryFallback\n            {...props}\n            plugin={props.plugin && toLegacyPlugin(props.plugin)}\n          />,\n        );\n      extensions.push(\n        createComponentExtension({\n          ref: coreComponentRefs.errorBoundaryFallback,\n          loader: {\n            sync: () => componentCompatWrapper(WrappedErrorBoundaryFallback),\n          },\n        }),\n      );\n    }\n  }\n\n  return createFrontendModule({\n    pluginId: 'app',\n    extensions,\n    featureFlags,\n  });\n}\n"],"names":[],"mappings":"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"}