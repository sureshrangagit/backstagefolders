{"version":3,"file":"collectEntityPageContents.esm.js","sources":["../src/collectEntityPageContents.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ApiHolder,\n  getComponentData,\n  BackstagePlugin as LegacyBackstagePlugin,\n} from '@backstage/core-plugin-api';\nimport { ExtensionDefinition } from '@backstage/frontend-plugin-api';\nimport { JSX, ReactNode, isValidElement, Children } from 'react';\nimport {\n  EntityCardBlueprint,\n  EntityContentBlueprint,\n} from '@backstage/plugin-catalog-react/alpha';\nimport { normalizeRoutePath } from './normalizeRoutePath';\n\nconst ENTITY_SWITCH_KEY = 'core.backstage.entitySwitch';\nconst ENTITY_ROUTE_KEY = 'plugin.catalog.entityLayoutRoute';\n\n// Placeholder to make sure internal types here are consistent\ntype Entity = { apiVersion: string; kind: string };\n\ntype EntityFilter = (entity: Entity, ctx: { apis: ApiHolder }) => boolean;\ntype AsyncEntityFilter = (\n  entity: Entity,\n  context: { apis: ApiHolder },\n) => boolean | Promise<boolean>;\n\nfunction allFilters(\n  ...ifs: (EntityFilter | undefined)[]\n): EntityFilter | undefined {\n  const filtered = ifs.filter(Boolean) as EntityFilter[];\n  if (!filtered.length) {\n    return undefined;\n  }\n  if (filtered.length === 1) {\n    return filtered[0];\n  }\n  return (entity, ctx) => filtered.every(ifFunc => ifFunc(entity, ctx));\n}\n\nfunction anyFilters(\n  ...ifs: (EntityFilter | undefined)[]\n): EntityFilter | undefined {\n  const filtered = ifs.filter(Boolean) as EntityFilter[];\n  if (!filtered.length) {\n    return undefined;\n  }\n  if (filtered.length === 1) {\n    return filtered[0];\n  }\n  return (entity, ctx) => filtered.some(ifFunc => ifFunc(entity, ctx));\n}\n\nfunction invertFilter(ifFunc?: EntityFilter): EntityFilter {\n  if (!ifFunc) {\n    return () => true;\n  }\n  return (entity, ctx) => !ifFunc(entity, ctx);\n}\n\nexport function collectEntityPageContents(\n  entityPageElement: JSX.Element,\n  context: {\n    discoverExtension(\n      extension: ExtensionDefinition,\n      plugin?: LegacyBackstagePlugin,\n    ): void;\n  },\n) {\n  let cardCounter = 1;\n  let routeCounter = 1;\n\n  function traverse(element: ReactNode, parentFilter?: EntityFilter) {\n    if (!isValidElement(element)) {\n      return;\n    }\n\n    const pageNode = maybeParseEntityPageNode(element);\n    if (pageNode) {\n      if (pageNode.type === 'route') {\n        const mergedIf = allFilters(parentFilter, pageNode.if);\n\n        if (pageNode.path === '/') {\n          context.discoverExtension(\n            EntityCardBlueprint.makeWithOverrides({\n              name: `discovered-${cardCounter++}`,\n              factory(originalFactory, { apis }) {\n                return originalFactory({\n                  type: 'content',\n                  filter: mergedIf && (entity => mergedIf(entity, { apis })),\n                  loader: () => Promise.resolve(pageNode.children),\n                });\n              },\n            }),\n          );\n        } else {\n          const name = `discovered-${routeCounter++}`;\n\n          context.discoverExtension(\n            EntityContentBlueprint.makeWithOverrides({\n              name,\n              factory(originalFactory, { apis }) {\n                return originalFactory({\n                  defaultPath: normalizeRoutePath(pageNode.path),\n                  defaultTitle: pageNode.title,\n                  filter: mergedIf && (entity => mergedIf(entity, { apis })),\n                  loader: () => Promise.resolve(pageNode.children),\n                });\n              },\n            }),\n            getComponentData<LegacyBackstagePlugin>(\n              pageNode.children,\n              'core.plugin',\n            ),\n          );\n        }\n      }\n      if (pageNode.type === 'switch') {\n        if (pageNode.renderMultipleMatches === 'all') {\n          for (const entityCase of pageNode.cases) {\n            traverse(\n              entityCase.children,\n              allFilters(parentFilter, entityCase.if),\n            );\n          }\n        } else {\n          let previousIf: EntityFilter = () => false;\n          for (const entityCase of pageNode.cases) {\n            const didNotMatchEarlier = invertFilter(previousIf);\n            traverse(\n              entityCase.children,\n              allFilters(parentFilter, entityCase.if, didNotMatchEarlier),\n            );\n            previousIf = anyFilters(previousIf, entityCase.if)!;\n          }\n        }\n      }\n      return;\n    }\n\n    Children.forEach(\n      (element.props as { children?: ReactNode })?.children,\n      child => {\n        traverse(child, parentFilter);\n      },\n    );\n  }\n\n  traverse(entityPageElement);\n}\n\ntype EntityRoute = {\n  type: 'route';\n  path: string;\n  title: string;\n  if?: EntityFilter;\n  children: JSX.Element;\n};\n\ntype EntitySwitchCase = {\n  if?: EntityFilter;\n  children: ReactNode;\n};\n\ntype EntitySwitch = {\n  type: 'switch';\n  cases: EntitySwitchCase[];\n  renderMultipleMatches: 'first' | 'all';\n};\n\nfunction wrapAsyncEntityFilter(\n  asyncFilter?: AsyncEntityFilter,\n): EntityFilter | undefined {\n  if (!asyncFilter) {\n    return asyncFilter;\n  }\n  let loggedError = false;\n  return (entity, ctx) => {\n    const result = asyncFilter(entity, ctx);\n    if (result && typeof result === 'object' && 'then' in result) {\n      if (!loggedError) {\n        // eslint-disable-next-line no-console\n        console.error(\n          `collectEntityPageContents does not support async entity filters, skipping filter ${asyncFilter}`,\n        );\n        loggedError = true;\n      }\n      return false;\n    }\n    return result;\n  };\n}\n\nfunction maybeParseEntityPageNode(\n  element: JSX.Element,\n): EntityRoute | EntitySwitch | undefined {\n  if (getComponentData(element, ENTITY_ROUTE_KEY)) {\n    const props = element.props as EntityRoute;\n    return {\n      type: 'route',\n      path: props.path,\n      title: props.title,\n      if: props.if,\n      children: props.children,\n    };\n  }\n\n  const parentProps = element.props as {\n    children?: ReactNode;\n    renderMultipleMatches?: 'first' | 'all';\n  };\n\n  const children = Children.toArray(parentProps?.children);\n  if (!children.length) {\n    return undefined;\n  }\n\n  const cases = [];\n  for (const child of children) {\n    if (!getComponentData(child, ENTITY_SWITCH_KEY)) {\n      return undefined;\n    }\n    const props = (child as { props: EntitySwitchCase }).props;\n\n    cases.push({\n      if: wrapAsyncEntityFilter(props.if),\n      children: props.children,\n    });\n  }\n  return {\n    type: 'switch',\n    cases,\n    renderMultipleMatches: parentProps?.renderMultipleMatches ?? 'first',\n  };\n}\n"],"names":[],"mappings":";;;;;AA6BA,MAAM,iBAAoB,GAAA,6BAAA;AAC1B,MAAM,gBAAmB,GAAA,kCAAA;AAWzB,SAAS,cACJ,GACuB,EAAA;AAC1B,EAAM,MAAA,QAAA,GAAW,GAAI,CAAA,MAAA,CAAO,OAAO,CAAA;AACnC,EAAI,IAAA,CAAC,SAAS,MAAQ,EAAA;AACpB,IAAO,OAAA,KAAA,CAAA;AAAA;AAET,EAAI,IAAA,QAAA,CAAS,WAAW,CAAG,EAAA;AACzB,IAAA,OAAO,SAAS,CAAC,CAAA;AAAA;AAEnB,EAAO,OAAA,CAAC,QAAQ,GAAQ,KAAA,QAAA,CAAS,MAAM,CAAU,MAAA,KAAA,MAAA,CAAO,MAAQ,EAAA,GAAG,CAAC,CAAA;AACtE;AAEA,SAAS,cACJ,GACuB,EAAA;AAC1B,EAAM,MAAA,QAAA,GAAW,GAAI,CAAA,MAAA,CAAO,OAAO,CAAA;AACnC,EAAI,IAAA,CAAC,SAAS,MAAQ,EAAA;AACpB,IAAO,OAAA,KAAA,CAAA;AAAA;AAET,EAAI,IAAA,QAAA,CAAS,WAAW,CAAG,EAAA;AACzB,IAAA,OAAO,SAAS,CAAC,CAAA;AAAA;AAEnB,EAAO,OAAA,CAAC,QAAQ,GAAQ,KAAA,QAAA,CAAS,KAAK,CAAU,MAAA,KAAA,MAAA,CAAO,MAAQ,EAAA,GAAG,CAAC,CAAA;AACrE;AAEA,SAAS,aAAa,MAAqC,EAAA;AACzD,EAAA,IAAI,CAAC,MAAQ,EAAA;AACX,IAAA,OAAO,MAAM,IAAA;AAAA;AAEf,EAAA,OAAO,CAAC,MAAQ,EAAA,GAAA,KAAQ,CAAC,MAAA,CAAO,QAAQ,GAAG,CAAA;AAC7C;AAEgB,SAAA,yBAAA,CACd,mBACA,OAMA,EAAA;AACA,EAAA,IAAI,WAAc,GAAA,CAAA;AAClB,EAAA,IAAI,YAAe,GAAA,CAAA;AAEnB,EAAS,SAAA,QAAA,CAAS,SAAoB,YAA6B,EAAA;AACjE,IAAI,IAAA,CAAC,cAAe,CAAA,OAAO,CAAG,EAAA;AAC5B,MAAA;AAAA;AAGF,IAAM,MAAA,QAAA,GAAW,yBAAyB,OAAO,CAAA;AACjD,IAAA,IAAI,QAAU,EAAA;AACZ,MAAI,IAAA,QAAA,CAAS,SAAS,OAAS,EAAA;AAC7B,QAAA,MAAM,QAAW,GAAA,UAAA,CAAW,YAAc,EAAA,QAAA,CAAS,EAAE,CAAA;AAErD,QAAI,IAAA,QAAA,CAAS,SAAS,GAAK,EAAA;AACzB,UAAQ,OAAA,CAAA,iBAAA;AAAA,YACN,oBAAoB,iBAAkB,CAAA;AAAA,cACpC,IAAA,EAAM,cAAc,WAAa,EAAA,CAAA,CAAA;AAAA,cACjC,OAAQ,CAAA,eAAA,EAAiB,EAAE,IAAA,EAAQ,EAAA;AACjC,gBAAA,OAAO,eAAgB,CAAA;AAAA,kBACrB,IAAM,EAAA,SAAA;AAAA,kBACN,QAAQ,QAAa,KAAA,CAAA,MAAA,KAAU,SAAS,MAAQ,EAAA,EAAE,MAAM,CAAA,CAAA;AAAA,kBACxD,MAAQ,EAAA,MAAM,OAAQ,CAAA,OAAA,CAAQ,SAAS,QAAQ;AAAA,iBAChD,CAAA;AAAA;AACH,aACD;AAAA,WACH;AAAA,SACK,MAAA;AACL,UAAM,MAAA,IAAA,GAAO,cAAc,YAAc,EAAA,CAAA,CAAA;AAEzC,UAAQ,OAAA,CAAA,iBAAA;AAAA,YACN,uBAAuB,iBAAkB,CAAA;AAAA,cACvC,IAAA;AAAA,cACA,OAAQ,CAAA,eAAA,EAAiB,EAAE,IAAA,EAAQ,EAAA;AACjC,gBAAA,OAAO,eAAgB,CAAA;AAAA,kBACrB,WAAA,EAAa,kBAAmB,CAAA,QAAA,CAAS,IAAI,CAAA;AAAA,kBAC7C,cAAc,QAAS,CAAA,KAAA;AAAA,kBACvB,QAAQ,QAAa,KAAA,CAAA,MAAA,KAAU,SAAS,MAAQ,EAAA,EAAE,MAAM,CAAA,CAAA;AAAA,kBACxD,MAAQ,EAAA,MAAM,OAAQ,CAAA,OAAA,CAAQ,SAAS,QAAQ;AAAA,iBAChD,CAAA;AAAA;AACH,aACD,CAAA;AAAA,YACD,gBAAA;AAAA,cACE,QAAS,CAAA,QAAA;AAAA,cACT;AAAA;AACF,WACF;AAAA;AACF;AAEF,MAAI,IAAA,QAAA,CAAS,SAAS,QAAU,EAAA;AAC9B,QAAI,IAAA,QAAA,CAAS,0BAA0B,KAAO,EAAA;AAC5C,UAAW,KAAA,MAAA,UAAA,IAAc,SAAS,KAAO,EAAA;AACvC,YAAA,QAAA;AAAA,cACE,UAAW,CAAA,QAAA;AAAA,cACX,UAAA,CAAW,YAAc,EAAA,UAAA,CAAW,EAAE;AAAA,aACxC;AAAA;AACF,SACK,MAAA;AACL,UAAA,IAAI,aAA2B,MAAM,KAAA;AACrC,UAAW,KAAA,MAAA,UAAA,IAAc,SAAS,KAAO,EAAA;AACvC,YAAM,MAAA,kBAAA,GAAqB,aAAa,UAAU,CAAA;AAClD,YAAA,QAAA;AAAA,cACE,UAAW,CAAA,QAAA;AAAA,cACX,UAAW,CAAA,YAAA,EAAc,UAAW,CAAA,EAAA,EAAI,kBAAkB;AAAA,aAC5D;AACA,YAAa,UAAA,GAAA,UAAA,CAAW,UAAY,EAAA,UAAA,CAAW,EAAE,CAAA;AAAA;AACnD;AACF;AAEF,MAAA;AAAA;AAGF,IAAS,QAAA,CAAA,OAAA;AAAA,MACN,QAAQ,KAAoC,EAAA,QAAA;AAAA,MAC7C,CAAS,KAAA,KAAA;AACP,QAAA,QAAA,CAAS,OAAO,YAAY,CAAA;AAAA;AAC9B,KACF;AAAA;AAGF,EAAA,QAAA,CAAS,iBAAiB,CAAA;AAC5B;AAqBA,SAAS,sBACP,WAC0B,EAAA;AAC1B,EAAA,IAAI,CAAC,WAAa,EAAA;AAChB,IAAO,OAAA,WAAA;AAAA;AAET,EAAA,IAAI,WAAc,GAAA,KAAA;AAClB,EAAO,OAAA,CAAC,QAAQ,GAAQ,KAAA;AACtB,IAAM,MAAA,MAAA,GAAS,WAAY,CAAA,MAAA,EAAQ,GAAG,CAAA;AACtC,IAAA,IAAI,MAAU,IAAA,OAAO,MAAW,KAAA,QAAA,IAAY,UAAU,MAAQ,EAAA;AAC5D,MAAA,IAAI,CAAC,WAAa,EAAA;AAEhB,QAAQ,OAAA,CAAA,KAAA;AAAA,UACN,oFAAoF,WAAW,CAAA;AAAA,SACjG;AACA,QAAc,WAAA,GAAA,IAAA;AAAA;AAEhB,MAAO,OAAA,KAAA;AAAA;AAET,IAAO,OAAA,MAAA;AAAA,GACT;AACF;AAEA,SAAS,yBACP,OACwC,EAAA;AACxC,EAAI,IAAA,gBAAA,CAAiB,OAAS,EAAA,gBAAgB,CAAG,EAAA;AAC/C,IAAA,MAAM,QAAQ,OAAQ,CAAA,KAAA;AACtB,IAAO,OAAA;AAAA,MACL,IAAM,EAAA,OAAA;AAAA,MACN,MAAM,KAAM,CAAA,IAAA;AAAA,MACZ,OAAO,KAAM,CAAA,KAAA;AAAA,MACb,IAAI,KAAM,CAAA,EAAA;AAAA,MACV,UAAU,KAAM,CAAA;AAAA,KAClB;AAAA;AAGF,EAAA,MAAM,cAAc,OAAQ,CAAA,KAAA;AAK5B,EAAA,MAAM,QAAW,GAAA,QAAA,CAAS,OAAQ,CAAA,WAAA,EAAa,QAAQ,CAAA;AACvD,EAAI,IAAA,CAAC,SAAS,MAAQ,EAAA;AACpB,IAAO,OAAA,KAAA,CAAA;AAAA;AAGT,EAAA,MAAM,QAAQ,EAAC;AACf,EAAA,KAAA,MAAW,SAAS,QAAU,EAAA;AAC5B,IAAA,IAAI,CAAC,gBAAA,CAAiB,KAAO,EAAA,iBAAiB,CAAG,EAAA;AAC/C,MAAO,OAAA,KAAA,CAAA;AAAA;AAET,IAAA,MAAM,QAAS,KAAsC,CAAA,KAAA;AAErD,IAAA,KAAA,CAAM,IAAK,CAAA;AAAA,MACT,EAAA,EAAI,qBAAsB,CAAA,KAAA,CAAM,EAAE,CAAA;AAAA,MAClC,UAAU,KAAM,CAAA;AAAA,KACjB,CAAA;AAAA;AAEH,EAAO,OAAA;AAAA,IACL,IAAM,EAAA,QAAA;AAAA,IACN,KAAA;AAAA,IACA,qBAAA,EAAuB,aAAa,qBAAyB,IAAA;AAAA,GAC/D;AACF;;;;"}