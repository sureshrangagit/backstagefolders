{"version":3,"file":"ContainerCard.esm.js","sources":["../../../../src/components/Pods/PodDrawer/ContainerCard.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { StructuredMetadataTable } from '@backstage/core-components';\nimport { ClientContainerStatus } from '@backstage/plugin-kubernetes-common';\nimport Card from '@material-ui/core/Card';\nimport CardActions from '@material-ui/core/CardActions';\nimport CardContent from '@material-ui/core/CardContent';\nimport CardHeader from '@material-ui/core/CardHeader';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport { IContainer, IContainerStatus } from 'kubernetes-models/v1';\nimport { DateTime } from 'luxon';\nimport { FC } from 'react';\n\nimport { useIsPodExecTerminalEnabled } from '../../../hooks';\nimport { bytesToMiB, formatMillicores } from '../../../utils/resources';\nimport { PodExecTerminalDialog } from '../../PodExecTerminal/PodExecTerminalDialog';\nimport { ResourceUtilization } from '../../ResourceUtilization';\nimport { PodLogsDialog, PodScope } from '../PodLogs';\n\nconst getContainerHealthChecks = (\n  containerSpec: IContainer,\n  containerStatus: IContainerStatus,\n): { [key: string]: boolean } => {\n  const healthCheck = {\n    'not waiting to start': containerStatus.state?.waiting === undefined,\n    'no restarts': containerStatus.restartCount === 0,\n  };\n  if (containerStatus.state?.terminated?.reason === 'Completed') {\n    return healthCheck;\n  }\n  Object.assign(\n    healthCheck,\n    { started: !!containerStatus.started },\n    { ready: containerStatus.ready },\n    { 'readiness probe set': containerSpec?.readinessProbe !== undefined },\n  );\n  if (containerSpec && containerSpec?.livenessProbe !== undefined) {\n    Object.assign(healthCheck, {\n      'liveness probe set': containerSpec.livenessProbe,\n    });\n  }\n  return healthCheck;\n};\n\nconst getCurrentState = (containerStatus: IContainerStatus): string => {\n  return (\n    containerStatus.state?.waiting?.reason ||\n    containerStatus.state?.terminated?.reason ||\n    (containerStatus.state?.running !== undefined ? 'Running' : 'Unknown')\n  );\n};\n\nconst getStartedAtTime = (\n  containerStatus: IContainerStatus,\n): string | undefined => {\n  return (\n    containerStatus.state?.running?.startedAt ||\n    containerStatus.state?.terminated?.startedAt\n  );\n};\n\ninterface ContainerDatetimeProps {\n  prefix: string;\n  dateTime: string;\n}\n\nconst ContainerDatetime = ({ prefix, dateTime }: ContainerDatetimeProps) => {\n  return (\n    <Typography variant=\"subtitle2\">\n      {prefix}:{' '}\n      {DateTime.fromISO(dateTime).toRelative({\n        locale: 'en',\n      })}\n    </Typography>\n  );\n};\n\n/**\n * Props for ContainerCard\n *\n * @public\n */\nexport interface ContainerCardProps {\n  podScope: PodScope;\n  containerSpec?: IContainer;\n  containerStatus: IContainerStatus;\n  containerMetrics?: ClientContainerStatus;\n}\n\n/**\n * Shows details about a container within a pod\n *\n * @public\n */\nexport const ContainerCard: FC<ContainerCardProps> = ({\n  podScope,\n  containerSpec,\n  containerStatus,\n  containerMetrics,\n}: ContainerCardProps) => {\n  const isPodExecTerminalEnabled = useIsPodExecTerminalEnabled();\n\n  // This should never be undefined\n  if (containerSpec === undefined) {\n    return <Typography>error reading pod from cluster</Typography>;\n  }\n  const containerStartedTime = getStartedAtTime(containerStatus);\n  const containerFinishedTime = containerStatus.state?.terminated?.finishedAt;\n\n  return (\n    <Card>\n      <CardHeader\n        title={containerStatus.name}\n        subheader={containerStatus.image}\n      />\n      <CardContent>\n        <Grid container>\n          <Grid item xs={12}>\n            {containerStartedTime && (\n              <ContainerDatetime\n                prefix=\"Started\"\n                dateTime={containerStartedTime}\n              />\n            )}\n            {containerFinishedTime && (\n              <ContainerDatetime\n                prefix=\"Completed\"\n                dateTime={containerFinishedTime}\n              />\n            )}\n            {containerStartedTime && containerFinishedTime && (\n              <Typography variant=\"subtitle2\">\n                Execution time:{' '}\n                {DateTime.fromISO(containerFinishedTime)\n                  .diff(DateTime.fromISO(containerStartedTime), [\n                    'hours',\n                    'minutes',\n                    'seconds',\n                  ])\n                  .toHuman()}\n              </Typography>\n            )}\n          </Grid>\n          <Grid item xs={12}>\n            <Typography variant=\"subtitle2\">\n              Status: {getCurrentState(containerStatus)}\n            </Typography>\n          </Grid>\n          {containerStatus.restartCount > 0 && (\n            <Grid item xs={12}>\n              <Typography variant=\"subtitle2\">\n                Restarts: {containerStatus.restartCount}\n              </Typography>\n            </Grid>\n          )}\n          <Grid item xs={12}>\n            <Typography variant=\"subtitle2\">Container health</Typography>\n          </Grid>\n          <Grid item xs={12}>\n            <StructuredMetadataTable\n              metadata={getContainerHealthChecks(\n                containerSpec,\n                containerStatus,\n              )}\n              options={{ nestedValuesAsYaml: true }}\n            />\n          </Grid>\n          {containerMetrics && (\n            <Grid container item xs={12} spacing={0}>\n              <Grid item xs={12}>\n                <Typography variant=\"subtitle1\">\n                  Resource utilization\n                </Typography>\n              </Grid>\n              <Grid item xs={12} style={{ minHeight: '5rem' }}>\n                <ResourceUtilization\n                  compressed\n                  title=\"CPU requests\"\n                  usage={containerMetrics.cpuUsage.currentUsage}\n                  total={containerMetrics.cpuUsage.requestTotal}\n                  totalFormatted={formatMillicores(\n                    containerMetrics.cpuUsage.requestTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"CPU limits\"\n                  usage={containerMetrics.cpuUsage.currentUsage}\n                  total={containerMetrics.cpuUsage.limitTotal}\n                  totalFormatted={formatMillicores(\n                    containerMetrics.cpuUsage.limitTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"Memory requests\"\n                  usage={containerMetrics.memoryUsage.currentUsage}\n                  total={containerMetrics.memoryUsage.requestTotal}\n                  totalFormatted={bytesToMiB(\n                    containerMetrics.memoryUsage.requestTotal,\n                  )}\n                />\n                <ResourceUtilization\n                  compressed\n                  title=\"Memory limits\"\n                  usage={containerMetrics.memoryUsage.currentUsage}\n                  total={containerMetrics.memoryUsage.limitTotal}\n                  totalFormatted={bytesToMiB(\n                    containerMetrics.memoryUsage.limitTotal,\n                  )}\n                />\n              </Grid>\n            </Grid>\n          )}\n        </Grid>\n      </CardContent>\n      <CardActions>\n        <PodLogsDialog\n          containerScope={{\n            containerName: containerStatus.name,\n            ...podScope,\n          }}\n        />\n        {isPodExecTerminalEnabled && (\n          <PodExecTerminalDialog\n            cluster={podScope.cluster}\n            containerName={containerStatus.name}\n            podName={podScope.podName}\n            podNamespace={podScope.podNamespace}\n          />\n        )}\n      </CardActions>\n    </Card>\n  );\n};\n"],"names":[],"mappings":"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"}