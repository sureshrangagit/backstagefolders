{"version":3,"file":"Rollout.esm.js","sources":["../../../../src/components/CustomResources/ArgoRollouts/Rollout.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ReactNode, useContext } from 'react';\nimport Accordion from '@material-ui/core/Accordion';\nimport AccordionDetails from '@material-ui/core/AccordionDetails';\nimport AccordionSummary from '@material-ui/core/AccordionSummary';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport ExpandMoreIcon from '@material-ui/icons/ExpandMore';\nimport type { V1Pod, V2HorizontalPodAutoscaler } from '@kubernetes/client-node';\nimport { PodsTable } from '../../Pods';\nimport { HorizontalPodAutoscalerDrawer } from '../../HorizontalPodAutoscalers';\nimport { RolloutDrawer } from './RolloutDrawer';\nimport PauseIcon from '@material-ui/icons/Pause';\nimport ErrorOutlineIcon from '@material-ui/icons/ErrorOutline';\nimport { DateTime } from 'luxon';\nimport { StepsProgress } from './StepsProgress';\nimport {\n  PodNamesWithErrorsContext,\n  GroupedResponsesContext,\n} from '../../../hooks';\nimport {\n  getMatchingHpa,\n  getOwnedPodsThroughReplicaSets,\n} from '../../../utils/owner';\nimport { StatusError, StatusOK } from '@backstage/core-components';\nimport { READY_COLUMNS, RESOURCE_COLUMNS } from '../../Pods/PodsTable';\n\ntype RolloutAccordionsProps = {\n  rollouts: any[];\n  defaultExpanded?: boolean;\n  children?: ReactNode;\n};\n\ntype RolloutAccordionProps = {\n  rollout: any;\n  ownedPods: V1Pod[];\n  defaultExpanded?: boolean;\n  matchingHpa?: V2HorizontalPodAutoscaler;\n  children?: ReactNode;\n};\n\ntype RolloutSummaryProps = {\n  rollout: any;\n  numberOfCurrentPods: number;\n  numberOfPodsWithErrors: number;\n  hpa?: V2HorizontalPodAutoscaler;\n  children?: ReactNode;\n};\n\nconst AbortedTitle = (\n  <div\n    style={{\n      display: 'flex',\n      alignItems: 'center',\n      flexWrap: 'wrap',\n    }}\n  >\n    <ErrorOutlineIcon />\n    <Typography variant=\"subtitle1\">Aborted</Typography>\n  </div>\n);\n\nconst findAbortedMessage = (rollout: any): string | undefined =>\n  rollout.status?.conditions?.find(\n    (c: any) =>\n      c.type === 'Progressing' &&\n      c.status === 'False' &&\n      c.reason === 'RolloutAborted',\n  )?.message;\n\nconst RolloutSummary = ({\n  rollout,\n  numberOfCurrentPods,\n  numberOfPodsWithErrors,\n  hpa,\n}: RolloutSummaryProps) => {\n  const pauseTime: string | undefined = rollout.status?.pauseConditions?.find(\n    (p: any) => p.reason === 'CanaryPauseStep',\n  )?.startTime;\n  const abortedMessage = findAbortedMessage(rollout);\n  const specCpuUtil = hpa?.spec?.metrics?.find(\n    metric => metric.type === 'Resource' && metric.resource?.name === 'cpu',\n  )?.resource?.target.averageUtilization;\n\n  const cpuUtil = hpa?.status?.currentMetrics?.find(\n    metric => metric.type === 'Resource' && metric.resource?.name === 'cpu',\n  )?.resource?.current.averageUtilization;\n\n  return (\n    <Grid\n      container\n      direction=\"row\"\n      justifyContent=\"space-between\"\n      alignItems=\"center\"\n      spacing={0}\n    >\n      <Grid xs={6} item>\n        <RolloutDrawer rollout={rollout} />\n      </Grid>\n      {hpa && (\n        <Grid item xs={3}>\n          <HorizontalPodAutoscalerDrawer hpa={hpa}>\n            <Grid\n              item\n              container\n              direction=\"column\"\n              justifyContent=\"flex-start\"\n              alignItems=\"flex-start\"\n              spacing={0}\n            >\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  min replicas {hpa.spec?.minReplicas ?? '?'} / max replicas{' '}\n                  {hpa.spec?.maxReplicas ?? '?'}\n                </Typography>\n              </Grid>\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  current CPU usage: {cpuUtil ?? '?'}%\n                </Typography>\n              </Grid>\n              <Grid item>\n                <Typography variant=\"subtitle2\">\n                  target CPU usage: {specCpuUtil ?? '?'}%\n                </Typography>\n              </Grid>\n            </Grid>\n          </HorizontalPodAutoscalerDrawer>\n        </Grid>\n      )}\n      <Grid\n        item\n        container\n        xs={3}\n        direction=\"column\"\n        justifyContent=\"flex-start\"\n        alignItems=\"flex-end\"\n        spacing={0}\n      >\n        <Grid item>\n          <StatusOK>{numberOfCurrentPods} pods</StatusOK>\n        </Grid>\n        <Grid item>\n          {numberOfPodsWithErrors > 0 ? (\n            <StatusError>\n              {numberOfPodsWithErrors} pod\n              {numberOfPodsWithErrors > 1 ? 's' : ''} with errors\n            </StatusError>\n          ) : (\n            <StatusOK>No pods with errors</StatusOK>\n          )}\n        </Grid>\n      </Grid>\n      {pauseTime && (\n        <Grid item xs={3}>\n          <div\n            style={{\n              display: 'flex',\n              alignItems: 'center',\n              flexWrap: 'wrap',\n            }}\n          >\n            <PauseIcon />\n            <Typography variant=\"subtitle1\">\n              Paused ({DateTime.fromISO(pauseTime).toRelative({ locale: 'en' })}\n              )\n            </Typography>\n          </div>\n        </Grid>\n      )}\n      {abortedMessage && (\n        <Grid item xs={3}>\n          {AbortedTitle}\n        </Grid>\n      )}\n    </Grid>\n  );\n};\n\nconst RolloutAccordion = ({\n  rollout,\n  ownedPods,\n  matchingHpa,\n  defaultExpanded,\n}: RolloutAccordionProps) => {\n  const podNamesWithErrors = useContext(PodNamesWithErrorsContext);\n\n  const podsWithErrors = ownedPods.filter(p =>\n    podNamesWithErrors.has(p.metadata?.name ?? ''),\n  );\n\n  const currentStepIndex = rollout.status?.currentStepIndex ?? 0;\n  const abortedMessage = findAbortedMessage(rollout);\n\n  return (\n    <Accordion\n      defaultExpanded={defaultExpanded}\n      TransitionProps={{ unmountOnExit: true }}\n      variant=\"outlined\"\n    >\n      <AccordionSummary expandIcon={<ExpandMoreIcon />}>\n        <RolloutSummary\n          rollout={rollout}\n          numberOfCurrentPods={ownedPods.length}\n          numberOfPodsWithErrors={podsWithErrors.length}\n          hpa={matchingHpa}\n        />\n      </AccordionSummary>\n      <AccordionDetails>\n        <div style={{ width: '100%' }}>\n          <div>\n            <Typography variant=\"h6\">Rollout status</Typography>\n          </div>\n          <div style={{ margin: '1rem' }}>\n            {abortedMessage && (\n              <>\n                {AbortedTitle}\n                <Typography variant=\"subtitle2\">{abortedMessage}</Typography>\n              </>\n            )}\n            <StepsProgress\n              aborted={abortedMessage !== undefined}\n              steps={rollout.spec?.strategy?.canary?.steps ?? []}\n              currentStepIndex={currentStepIndex}\n            />\n          </div>\n          <div>\n            <PodsTable\n              pods={ownedPods}\n              extraColumns={[READY_COLUMNS, RESOURCE_COLUMNS]}\n            />\n          </div>\n        </div>\n      </AccordionDetails>\n    </Accordion>\n  );\n};\n\nexport const RolloutAccordions = ({\n  rollouts,\n  defaultExpanded = false,\n}: RolloutAccordionsProps) => {\n  const groupedResponses = useContext(GroupedResponsesContext);\n\n  return (\n    <Grid\n      container\n      direction=\"column\"\n      justifyContent=\"flex-start\"\n      alignItems=\"flex-start\"\n    >\n      {rollouts.map((rollout, i) => (\n        <Grid container item key={i} xs>\n          <Grid item xs>\n            <RolloutAccordion\n              defaultExpanded={defaultExpanded}\n              matchingHpa={getMatchingHpa(\n                {\n                  name: rollout.metadata?.name,\n                  namespace: rollout.metadata?.namespace,\n                  kind: 'rollout',\n                },\n                groupedResponses.horizontalPodAutoscalers,\n              )}\n              ownedPods={getOwnedPodsThroughReplicaSets(\n                rollout,\n                groupedResponses.replicaSets,\n                groupedResponses.pods,\n              )}\n              rollout={rollout}\n            />\n          </Grid>\n        </Grid>\n      ))}\n    </Grid>\n  );\n};\n"],"names":[],"mappings":"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"}