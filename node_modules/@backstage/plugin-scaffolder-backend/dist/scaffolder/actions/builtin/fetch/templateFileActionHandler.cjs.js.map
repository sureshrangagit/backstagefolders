{"version":3,"file":"templateFileActionHandler.cjs.js","sources":["../../../../../src/scaffolder/actions/builtin/fetch/templateFileActionHandler.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ScmIntegrations } from '@backstage/integration';\nimport {\n  ActionContext,\n  TemplateFilter,\n  TemplateGlobal,\n} from '@backstage/plugin-scaffolder-node';\nimport fs from 'fs-extra';\nimport { createDefaultFilters } from '../../../../lib/templating/filters/createDefaultFilters';\nimport { convertFiltersToRecord } from '../../../../util/templating';\nimport { resolveSafeChildPath } from '@backstage/backend-plugin-api';\nimport path from 'path';\nimport { SecureTemplater } from '../../../../lib/templating/SecureTemplater';\n\nexport type TemplateFileActionInput = {\n  targetPath: string;\n  values: any;\n  cookiecutterCompat?: boolean;\n  replace?: boolean;\n  trimBlocks?: boolean;\n  lstripBlocks?: boolean;\n};\n\nexport async function createTemplateFileActionHandler<\n  I extends TemplateFileActionInput = TemplateFileActionInput,\n>(options: {\n  ctx: ActionContext<I, any, any>;\n  resolveTemplateFile: () => Promise<string>;\n  integrations: ScmIntegrations;\n  additionalTemplateFilters?: Record<string, TemplateFilter>;\n  additionalTemplateGlobals?: Record<string, TemplateGlobal>;\n}) {\n  const {\n    resolveTemplateFile,\n    integrations,\n    additionalTemplateFilters,\n    additionalTemplateGlobals: templateGlobals,\n    ctx,\n  } = options;\n\n  const templateFilters = {\n    ...convertFiltersToRecord(createDefaultFilters({ integrations })),\n    ...additionalTemplateFilters,\n  };\n\n  const outputPath = resolveSafeChildPath(\n    ctx.workspacePath,\n    ctx.input.targetPath,\n  );\n\n  if (fs.existsSync(outputPath) && !ctx.input.replace) {\n    ctx.logger.info(\n      `File ${ctx.input.targetPath} already exists in workspace, not replacing.`,\n    );\n    return;\n  }\n  const filePath = await resolveTemplateFile();\n\n  const { cookiecutterCompat, values } = ctx.input;\n  const context = {\n    [cookiecutterCompat ? 'cookiecutter' : 'values']: values,\n  };\n\n  ctx.logger.info(\n    `Processing template file with input values`,\n    ctx.input.values,\n  );\n\n  const renderTemplate = await SecureTemplater.loadRenderer({\n    cookiecutterCompat,\n    templateFilters,\n    templateGlobals,\n    nunjucksConfigs: {\n      trimBlocks: ctx.input.trimBlocks,\n      lstripBlocks: ctx.input.lstripBlocks,\n    },\n  });\n\n  const contents = await fs.readFile(filePath, 'utf-8');\n  const result = renderTemplate(contents, context);\n  await fs.ensureDir(path.dirname(outputPath));\n  await fs.outputFile(outputPath, result);\n\n  ctx.logger.info(`Template file has been written to ${outputPath}`);\n}\n"],"names":["convertFiltersToRecord","createDefaultFilters","resolveSafeChildPath","fs","SecureTemplater","path"],"mappings":";;;;;;;;;;;;;;AAqCA,eAAsB,gCAEpB,OAMC,EAAA;AACD,EAAM,MAAA;AAAA,IACJ,mBAAA;AAAA,IACA,YAAA;AAAA,IACA,yBAAA;AAAA,IACA,yBAA2B,EAAA,eAAA;AAAA,IAC3B;AAAA,GACE,GAAA,OAAA;AAEJ,EAAA,MAAM,eAAkB,GAAA;AAAA,IACtB,GAAGA,iCAAuB,CAAAC,yCAAA,CAAqB,EAAE,YAAA,EAAc,CAAC,CAAA;AAAA,IAChE,GAAG;AAAA,GACL;AAEA,EAAA,MAAM,UAAa,GAAAC,qCAAA;AAAA,IACjB,GAAI,CAAA,aAAA;AAAA,IACJ,IAAI,KAAM,CAAA;AAAA,GACZ;AAEA,EAAA,IAAIC,oBAAG,UAAW,CAAA,UAAU,KAAK,CAAC,GAAA,CAAI,MAAM,OAAS,EAAA;AACnD,IAAA,GAAA,CAAI,MAAO,CAAA,IAAA;AAAA,MACT,CAAA,KAAA,EAAQ,GAAI,CAAA,KAAA,CAAM,UAAU,CAAA,4CAAA;AAAA,KAC9B;AACA,IAAA;AAAA;AAEF,EAAM,MAAA,QAAA,GAAW,MAAM,mBAAoB,EAAA;AAE3C,EAAA,MAAM,EAAE,kBAAA,EAAoB,MAAO,EAAA,GAAI,GAAI,CAAA,KAAA;AAC3C,EAAA,MAAM,OAAU,GAAA;AAAA,IACd,CAAC,kBAAA,GAAqB,cAAiB,GAAA,QAAQ,GAAG;AAAA,GACpD;AAEA,EAAA,GAAA,CAAI,MAAO,CAAA,IAAA;AAAA,IACT,CAAA,0CAAA,CAAA;AAAA,IACA,IAAI,KAAM,CAAA;AAAA,GACZ;AAEA,EAAM,MAAA,cAAA,GAAiB,MAAMC,+BAAA,CAAgB,YAAa,CAAA;AAAA,IACxD,kBAAA;AAAA,IACA,eAAA;AAAA,IACA,eAAA;AAAA,IACA,eAAiB,EAAA;AAAA,MACf,UAAA,EAAY,IAAI,KAAM,CAAA,UAAA;AAAA,MACtB,YAAA,EAAc,IAAI,KAAM,CAAA;AAAA;AAC1B,GACD,CAAA;AAED,EAAA,MAAM,QAAW,GAAA,MAAMD,mBAAG,CAAA,QAAA,CAAS,UAAU,OAAO,CAAA;AACpD,EAAM,MAAA,MAAA,GAAS,cAAe,CAAA,QAAA,EAAU,OAAO,CAAA;AAC/C,EAAA,MAAMA,mBAAG,CAAA,SAAA,CAAUE,qBAAK,CAAA,OAAA,CAAQ,UAAU,CAAC,CAAA;AAC3C,EAAM,MAAAF,mBAAA,CAAG,UAAW,CAAA,UAAA,EAAY,MAAM,CAAA;AAEtC,EAAA,GAAA,CAAI,MAAO,CAAA,IAAA,CAAK,CAAqC,kCAAA,EAAA,UAAU,CAAE,CAAA,CAAA;AACnE;;;;"}