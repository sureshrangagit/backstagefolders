{"version":3,"file":"read.cjs.js","sources":["../../../../../src/scaffolder/actions/builtin/filesystem/read.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createTemplateAction } from '@backstage/plugin-scaffolder-node';\nimport { resolveSafeChildPath } from '@backstage/backend-plugin-api';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { z as zod } from 'zod';\nimport { examples } from './rename.examples';\n\nconst contentSchema = (z: typeof zod) =>\n  z.object({\n    name: z.string().describe('Name of the file or directory'),\n    path: z\n      .string()\n      .describe('path to the file or directory relative to the workspace'),\n    fullPath: z.string().describe('full path to the file or directory'),\n  });\n\ntype Content = zod.infer<ReturnType<typeof contentSchema>>;\n\n/**\n * Creates new action that enables reading directories in the workspace.\n * @public\n */\nexport const createFilesystemReadDirAction = () => {\n  return createTemplateAction({\n    id: 'fs:readdir',\n    description: 'Reads files and directories from the workspace',\n    supportsDryRun: true,\n    examples,\n    schema: {\n      input: {\n        paths: z => z.array(z.string().min(1)),\n        recursive: z => z.boolean().default(false),\n      },\n      output: {\n        files: z => z.array(contentSchema(z)),\n        folders: z => z.array(contentSchema(z)),\n      },\n    },\n    async handler(ctx) {\n      const files: Content[] = [];\n      const folders: Content[] = [];\n\n      for (const localPath of ctx.input.paths) {\n        const fullWorkspacePath = resolveSafeChildPath(\n          ctx.workspacePath,\n          localPath,\n        );\n        const content = await fs.readdir(fullWorkspacePath, {\n          recursive: ctx.input.recursive,\n          withFileTypes: true,\n        });\n        for (const dirent of content) {\n          const fullPath = path.join(dirent.parentPath, dirent.name);\n          const element = {\n            name: dirent.name,\n            path: path.relative(ctx.workspacePath, fullPath),\n            fullPath,\n          };\n          if (dirent.isDirectory()) {\n            folders.push(element);\n          } else {\n            files.push(element);\n          }\n        }\n      }\n\n      ctx.output('files', files);\n      ctx.output('folders', folders);\n    },\n  });\n};\n"],"names":["createTemplateAction","examples","resolveSafeChildPath","fs","path"],"mappings":";;;;;;;;;;;;;AAsBA,MAAM,aAAgB,GAAA,CAAC,CACrB,KAAA,CAAA,CAAE,MAAO,CAAA;AAAA,EACP,IAAM,EAAA,CAAA,CAAE,MAAO,EAAA,CAAE,SAAS,+BAA+B,CAAA;AAAA,EACzD,IAAM,EAAA,CAAA,CACH,MAAO,EAAA,CACP,SAAS,yDAAyD,CAAA;AAAA,EACrE,QAAU,EAAA,CAAA,CAAE,MAAO,EAAA,CAAE,SAAS,oCAAoC;AACpE,CAAC,CAAA;AAQI,MAAM,gCAAgC,MAAM;AACjD,EAAA,OAAOA,yCAAqB,CAAA;AAAA,IAC1B,EAAI,EAAA,YAAA;AAAA,IACJ,WAAa,EAAA,gDAAA;AAAA,IACb,cAAgB,EAAA,IAAA;AAAA,cAChBC,wBAAA;AAAA,IACA,MAAQ,EAAA;AAAA,MACN,KAAO,EAAA;AAAA,QACL,KAAA,EAAO,OAAK,CAAE,CAAA,KAAA,CAAM,EAAE,MAAO,EAAA,CAAE,GAAI,CAAA,CAAC,CAAC,CAAA;AAAA,QACrC,WAAW,CAAK,CAAA,KAAA,CAAA,CAAE,OAAQ,EAAA,CAAE,QAAQ,KAAK;AAAA,OAC3C;AAAA,MACA,MAAQ,EAAA;AAAA,QACN,OAAO,CAAK,CAAA,KAAA,CAAA,CAAE,KAAM,CAAA,aAAA,CAAc,CAAC,CAAC,CAAA;AAAA,QACpC,SAAS,CAAK,CAAA,KAAA,CAAA,CAAE,KAAM,CAAA,aAAA,CAAc,CAAC,CAAC;AAAA;AACxC,KACF;AAAA,IACA,MAAM,QAAQ,GAAK,EAAA;AACjB,MAAA,MAAM,QAAmB,EAAC;AAC1B,MAAA,MAAM,UAAqB,EAAC;AAE5B,MAAW,KAAA,MAAA,SAAA,IAAa,GAAI,CAAA,KAAA,CAAM,KAAO,EAAA;AACvC,QAAA,MAAM,iBAAoB,GAAAC,qCAAA;AAAA,UACxB,GAAI,CAAA,aAAA;AAAA,UACJ;AAAA,SACF;AACA,QAAA,MAAM,OAAU,GAAA,MAAMC,mBAAG,CAAA,OAAA,CAAQ,iBAAmB,EAAA;AAAA,UAClD,SAAA,EAAW,IAAI,KAAM,CAAA,SAAA;AAAA,UACrB,aAAe,EAAA;AAAA,SAChB,CAAA;AACD,QAAA,KAAA,MAAW,UAAU,OAAS,EAAA;AAC5B,UAAA,MAAM,WAAWC,qBAAK,CAAA,IAAA,CAAK,MAAO,CAAA,UAAA,EAAY,OAAO,IAAI,CAAA;AACzD,UAAA,MAAM,OAAU,GAAA;AAAA,YACd,MAAM,MAAO,CAAA,IAAA;AAAA,YACb,IAAM,EAAAA,qBAAA,CAAK,QAAS,CAAA,GAAA,CAAI,eAAe,QAAQ,CAAA;AAAA,YAC/C;AAAA,WACF;AACA,UAAI,IAAA,MAAA,CAAO,aAAe,EAAA;AACxB,YAAA,OAAA,CAAQ,KAAK,OAAO,CAAA;AAAA,WACf,MAAA;AACL,YAAA,KAAA,CAAM,KAAK,OAAO,CAAA;AAAA;AACpB;AACF;AAGF,MAAI,GAAA,CAAA,MAAA,CAAO,SAAS,KAAK,CAAA;AACzB,MAAI,GAAA,CAAA,MAAA,CAAO,WAAW,OAAO,CAAA;AAAA;AAC/B,GACD,CAAA;AACH;;;;"}