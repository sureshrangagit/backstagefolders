{"version":3,"file":"templating.cjs.js","sources":["../../src/util/templating.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {\n  TemplateFilter,\n  TemplateGlobal,\n} from '@backstage/plugin-scaffolder-node';\nimport {\n  CreatedTemplateFilter,\n  CreatedTemplateGlobal,\n  CreatedTemplateGlobalFunction,\n  CreatedTemplateGlobalValue,\n  ZodFunctionSchema,\n} from '@backstage/plugin-scaffolder-node/alpha';\nimport { JsonValue } from '@backstage/types';\nimport { Schema } from 'jsonschema';\nimport { ZodType, z } from 'zod';\nimport zodToJsonSchema from 'zod-to-json-schema';\n\n/**\n * Converts template filters to a record of filter functions\n */\nexport function convertFiltersToRecord(\n  filters?: Record<string, TemplateFilter> | CreatedTemplateFilter<any, any>[],\n): Record<string, TemplateFilter> {\n  if (!filters) {\n    return {};\n  }\n\n  if (Array.isArray(filters)) {\n    const result: Record<string, TemplateFilter> = {};\n    for (const filter of filters) {\n      result[filter.id] = filter.filter as TemplateFilter;\n    }\n    return result;\n  }\n\n  return filters;\n}\n\ntype ExportFunctionSchema = {\n  arguments?: Schema[];\n  output?: Schema;\n};\n\ntype ExportFilterSchema = {\n  input?: Schema;\n} & ExportFunctionSchema;\n\n/**\n * Converts a Zod function schema to JSON schema\n */\nfunction convertZodFunctionToJsonSchema(\n  t: ReturnType<ZodFunctionSchema<any, any>>,\n): ExportFunctionSchema {\n  if (!('parameters' in t) || !('returnType' in t)) {\n    throw new Error('Invalid Zod function schema');\n  }\n\n  const args = (t.parameters().items as ZodType[]).map(\n    zt => zodToJsonSchema(zt) as Schema,\n  );\n\n  let output: Schema | undefined = undefined;\n  const returnType = t.returnType();\n  if (!returnType._unknown) {\n    output = zodToJsonSchema(returnType) as Schema;\n  }\n\n  const result: ExportFunctionSchema = {};\n  if (args.length > 0) {\n    result.arguments = args;\n  }\n  if (output) {\n    result.output = output;\n  }\n\n  return result;\n}\n\n/**\n * Converts a function schema to a filter schema\n */\nfunction convertToFilterSchema(\n  fnSchema: ExportFunctionSchema,\n): ExportFilterSchema {\n  if (fnSchema.arguments?.length) {\n    const [input, ...rest] = fnSchema.arguments;\n    const result: ExportFilterSchema = { input };\n\n    if (rest.length > 0) {\n      result.arguments = rest;\n    }\n\n    if (fnSchema.output) {\n      result.output = fnSchema.output;\n    }\n\n    return result;\n  }\n  return fnSchema;\n}\n\ntype ExportFilter = Pick<\n  CreatedTemplateFilter<any, any>,\n  'description' | 'examples'\n> & {\n  schema?: ExportFilterSchema;\n};\n\n/**\n * Extracts metadata from template filters\n */\nexport function extractFilterMetadata(\n  filters?: Record<string, TemplateFilter> | CreatedTemplateFilter<any, any>[],\n): Record<string, ExportFilter> {\n  if (!filters) {\n    return {};\n  }\n\n  if (Array.isArray(filters)) {\n    const result: Record<string, ExportFilter> = {};\n\n    for (const filter of filters) {\n      const metadata: ExportFilter = {};\n\n      if (filter.description) {\n        metadata.description = filter.description;\n      }\n\n      if (filter.examples) {\n        metadata.examples = filter.examples;\n      }\n\n      if (filter.schema) {\n        metadata.schema = convertToFilterSchema(\n          convertZodFunctionToJsonSchema(\n            filter.schema(z) as z.ZodFunction<any, any>,\n          ),\n        );\n      }\n\n      result[filter.id] = metadata;\n    }\n\n    return result;\n  }\n\n  // For non-array filters, return empty metadata\n  const result: Record<string, ExportFilter> = {};\n  for (const key in filters) {\n    if (filters.hasOwnProperty(key)) {\n      result[key] = {};\n    }\n  }\n  return result;\n}\n\n/**\n * Checks if a global is a function\n */\nfunction isGlobalFunction(\n  global: CreatedTemplateGlobal,\n): global is CreatedTemplateGlobalFunction<any, any> {\n  return 'fn' in global;\n}\n\n/**\n * Extracts metadata from template global functions\n */\nexport function extractGlobalFunctionMetadata(\n  globals?: Record<string, TemplateGlobal> | CreatedTemplateGlobal[],\n): Record<\n  string,\n  Pick<CreatedTemplateGlobalFunction<any, any>, 'description' | 'examples'> & {\n    schema?: ExportFunctionSchema;\n  }\n> {\n  if (!globals) {\n    return {};\n  }\n\n  if (Array.isArray(globals)) {\n    const result: Record<string, any> = {};\n\n    for (const global of globals) {\n      if (isGlobalFunction(global)) {\n        const metadata: any = {};\n\n        if (global.description) {\n          metadata.description = global.description;\n        }\n\n        if (global.examples) {\n          metadata.examples = global.examples;\n        }\n\n        if (global.schema) {\n          metadata.schema = convertZodFunctionToJsonSchema(global.schema(z));\n        }\n\n        result[global.id] = metadata;\n      }\n    }\n\n    return result;\n  }\n\n  // For non-array globals, extract function metadata\n  const result: Record<string, any> = {};\n  for (const key in globals) {\n    if (typeof globals[key] === 'function') {\n      result[key] = {};\n    }\n  }\n  return result;\n}\n\n/**\n * Extracts metadata from template global values\n */\nexport function extractGlobalValueMetadata(\n  globals?: Record<string, TemplateGlobal> | CreatedTemplateGlobal[],\n): Record<string, Omit<CreatedTemplateGlobalValue, 'id'>> {\n  if (!globals) {\n    return {};\n  }\n\n  if (Array.isArray(globals)) {\n    const result: Record<string, Omit<CreatedTemplateGlobalValue, 'id'>> = {};\n\n    for (const global of globals) {\n      if (!isGlobalFunction(global)) {\n        result[global.id] = {\n          value: (global as CreatedTemplateGlobalValue).value,\n          description: global.description,\n        };\n      }\n    }\n\n    return result;\n  }\n\n  // For non-array globals, extract value metadata\n  const result: Record<string, Omit<CreatedTemplateGlobalValue, 'id'>> = {};\n  for (const key in globals) {\n    if (typeof globals[key] !== 'function') {\n      result[key] = { value: globals[key] as JsonValue };\n    }\n  }\n  return result;\n}\n\n/**\n * Converts template globals to a record of global values and functions\n */\nexport function convertGlobalsToRecord(\n  globals?: Record<string, TemplateGlobal> | CreatedTemplateGlobal[],\n): Record<string, TemplateGlobal> {\n  if (!globals) {\n    return {};\n  }\n\n  if (!Array.isArray(globals)) {\n    return globals;\n  }\n\n  const result: Record<string, TemplateGlobal> = {};\n  for (const global of globals) {\n    result[global.id] = isGlobalFunction(global)\n      ? (global.fn as TemplateGlobal)\n      : (global as CreatedTemplateGlobalValue).value;\n  }\n  return result;\n}\n"],"names":["zodToJsonSchema","result","z"],"mappings":"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"}