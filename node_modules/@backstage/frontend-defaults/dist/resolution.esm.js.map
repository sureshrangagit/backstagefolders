{"version":3,"file":"resolution.esm.js","sources":["../src/resolution.ts"],"sourcesContent":["/*\n * Copyright 2025 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { stringifyError } from '@backstage/errors';\nimport {\n  FrontendFeature,\n  FrontendFeatureLoader,\n} from '@backstage/frontend-plugin-api';\nimport { CreateAppFeatureLoader } from './createApp';\n// eslint-disable-next-line @backstage/no-relative-monorepo-imports\nimport { isInternalFrontendFeatureLoader } from '../../frontend-plugin-api/src/wiring/createFrontendFeatureLoader';\n\n/** @public */\nexport async function resolveAsyncFeatures(options: {\n  config: Config;\n  features?: (\n    | FrontendFeature\n    | FrontendFeatureLoader\n    | CreateAppFeatureLoader\n  )[];\n}): Promise<{ features: FrontendFeature[] }> {\n  const features: (FrontendFeature | FrontendFeatureLoader)[] = [];\n\n  // Separate deprecated CreateAppFeatureLoader elements from the frontend features,\n  // and manage the deprecated elements first.\n  for (const item of options?.features ?? []) {\n    if ('load' in item) {\n      try {\n        const result = await item.load({ config: options.config });\n        features.push(...result.features);\n      } catch (e) {\n        throw new Error(\n          `Failed to read frontend features from loader '${item.getLoaderName()}', ${stringifyError(\n            e,\n          )}`,\n        );\n      }\n    } else {\n      features.push(item);\n    }\n  }\n\n  const loadedFeatures: FrontendFeature[] = [];\n  const alreadyMetFeatureLoaders: FrontendFeatureLoader[] = [];\n  const maxRecursionDepth = 5;\n\n  async function applyFeatureLoaders(\n    featuresOrLoaders: (FrontendFeature | FrontendFeatureLoader)[],\n    recursionDepth: number,\n  ) {\n    if (featuresOrLoaders.length === 0) {\n      return;\n    }\n\n    for (const featureOrLoader of featuresOrLoaders) {\n      if (isBackstageFeatureLoader(featureOrLoader)) {\n        if (alreadyMetFeatureLoaders.some(l => l === featureOrLoader)) {\n          continue;\n        }\n        if (isInternalFrontendFeatureLoader(featureOrLoader)) {\n          if (recursionDepth > maxRecursionDepth) {\n            throw new Error(\n              `Maximum feature loading recursion depth (${maxRecursionDepth}) reached for the feature loader ${featureOrLoader.description}`,\n            );\n          }\n          alreadyMetFeatureLoaders.push(featureOrLoader);\n          let result: (FrontendFeature | FrontendFeatureLoader)[];\n          try {\n            result = await featureOrLoader.loader({ config: options.config });\n          } catch (e) {\n            throw new Error(\n              `Failed to read frontend features from loader ${\n                featureOrLoader.description\n              }: ${stringifyError(e)}`,\n            );\n          }\n          await applyFeatureLoaders(result, recursionDepth + 1);\n        }\n      } else {\n        loadedFeatures.push(featureOrLoader);\n      }\n    }\n  }\n\n  await applyFeatureLoaders(features, 1);\n\n  return { features: loadedFeatures };\n}\n\nexport function isBackstageFeatureLoader(\n  obj: unknown,\n): obj is FrontendFeatureLoader {\n  return (\n    obj !== null &&\n    typeof obj === 'object' &&\n    '$$type' in obj &&\n    obj.$$type === '@backstage/FrontendFeatureLoader'\n  );\n}\n"],"names":[],"mappings":";;;AA2BA,eAAsB,qBAAqB,OAOE,EAAA;AAC3C,EAAA,MAAM,WAAwD,EAAC;AAI/D,EAAA,KAAA,MAAW,IAAQ,IAAA,OAAA,EAAS,QAAY,IAAA,EAAI,EAAA;AAC1C,IAAA,IAAI,UAAU,IAAM,EAAA;AAClB,MAAI,IAAA;AACF,QAAM,MAAA,MAAA,GAAS,MAAM,IAAK,CAAA,IAAA,CAAK,EAAE,MAAQ,EAAA,OAAA,CAAQ,QAAQ,CAAA;AACzD,QAAS,QAAA,CAAA,IAAA,CAAK,GAAG,MAAA,CAAO,QAAQ,CAAA;AAAA,eACzB,CAAG,EAAA;AACV,QAAA,MAAM,IAAI,KAAA;AAAA,UACR,CAAiD,8CAAA,EAAA,IAAA,CAAK,aAAc,EAAC,CAAM,GAAA,EAAA,cAAA;AAAA,YACzE;AAAA,WACD,CAAA;AAAA,SACH;AAAA;AACF,KACK,MAAA;AACL,MAAA,QAAA,CAAS,KAAK,IAAI,CAAA;AAAA;AACpB;AAGF,EAAA,MAAM,iBAAoC,EAAC;AAC3C,EAAA,MAAM,2BAAoD,EAAC;AAC3D,EAAA,MAAM,iBAAoB,GAAA,CAAA;AAE1B,EAAe,eAAA,mBAAA,CACb,mBACA,cACA,EAAA;AACA,IAAI,IAAA,iBAAA,CAAkB,WAAW,CAAG,EAAA;AAClC,MAAA;AAAA;AAGF,IAAA,KAAA,MAAW,mBAAmB,iBAAmB,EAAA;AAC/C,MAAI,IAAA,wBAAA,CAAyB,eAAe,CAAG,EAAA;AAC7C,QAAA,IAAI,wBAAyB,CAAA,IAAA,CAAK,CAAK,CAAA,KAAA,CAAA,KAAM,eAAe,CAAG,EAAA;AAC7D,UAAA;AAAA;AAEF,QAAI,IAAA,+BAAA,CAAgC,eAAe,CAAG,EAAA;AACpD,UAAA,IAAI,iBAAiB,iBAAmB,EAAA;AACtC,YAAA,MAAM,IAAI,KAAA;AAAA,cACR,CAA4C,yCAAA,EAAA,iBAAiB,CAAoC,iCAAA,EAAA,eAAA,CAAgB,WAAW,CAAA;AAAA,aAC9H;AAAA;AAEF,UAAA,wBAAA,CAAyB,KAAK,eAAe,CAAA;AAC7C,UAAI,IAAA,MAAA;AACJ,UAAI,IAAA;AACF,YAAA,MAAA,GAAS,MAAM,eAAgB,CAAA,MAAA,CAAO,EAAE,MAAQ,EAAA,OAAA,CAAQ,QAAQ,CAAA;AAAA,mBACzD,CAAG,EAAA;AACV,YAAA,MAAM,IAAI,KAAA;AAAA,cACR,gDACE,eAAgB,CAAA,WAClB,CAAK,EAAA,EAAA,cAAA,CAAe,CAAC,CAAC,CAAA;AAAA,aACxB;AAAA;AAEF,UAAM,MAAA,mBAAA,CAAoB,MAAQ,EAAA,cAAA,GAAiB,CAAC,CAAA;AAAA;AACtD,OACK,MAAA;AACL,QAAA,cAAA,CAAe,KAAK,eAAe,CAAA;AAAA;AACrC;AACF;AAGF,EAAM,MAAA,mBAAA,CAAoB,UAAU,CAAC,CAAA;AAErC,EAAO,OAAA,EAAE,UAAU,cAAe,EAAA;AACpC;AAEO,SAAS,yBACd,GAC8B,EAAA;AAC9B,EACE,OAAA,GAAA,KAAQ,QACR,OAAO,GAAA,KAAQ,YACf,QAAY,IAAA,GAAA,IACZ,IAAI,MAAW,KAAA,kCAAA;AAEnB;;;;"}