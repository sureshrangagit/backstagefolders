{"version":3,"file":"renderInTestApp.esm.js","sources":["../../src/app/renderInTestApp.tsx"],"sourcesContent":["/*\n * Copyright 2023 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Fragment } from 'react';\nimport { Link, MemoryRouter } from 'react-router-dom';\nimport {\n  createSpecializedApp,\n  FrontendFeature,\n} from '@backstage/frontend-app-api';\nimport { RenderResult, render } from '@testing-library/react';\nimport { ConfigReader } from '@backstage/config';\nimport { JsonObject } from '@backstage/types';\nimport {\n  createExtension,\n  ExtensionDefinition,\n  coreExtensionData,\n  RouteRef,\n  useRouteRef,\n  IconComponent,\n  RouterBlueprint,\n  NavItemBlueprint,\n  createFrontendPlugin,\n} from '@backstage/frontend-plugin-api';\nimport appPlugin from '@backstage/plugin-app';\n\nconst DEFAULT_MOCK_CONFIG = {\n  app: { baseUrl: 'http://localhost:3000' },\n  backend: { baseUrl: 'http://localhost:7007' },\n};\n\n/**\n * Options to customize the behavior of the test app.\n * @public\n */\nexport type TestAppOptions = {\n  /**\n   * An object of paths to mount route ref on, with the key being the path and the value\n   * being the RouteRef that the path will be bound to. This allows the route refs to be\n   * used by `useRouteRef` in the rendered elements.\n   *\n   * @example\n   * ```ts\n   * renderInTestApp(<MyComponent />, {\n   *   mountedRoutes: {\n   *     '/my-path': myRouteRef,\n   *   }\n   * })\n   * // ...\n   * const link = useRouteRef(myRouteRef)\n   * ```\n   */\n  mountedRoutes?: { [path: string]: RouteRef };\n\n  /**\n   * Additional configuration passed to the app when rendering elements inside it.\n   */\n  config?: JsonObject;\n\n  /**\n   * Additional extensions to add to the test app.\n   */\n  extensions?: ExtensionDefinition<any>[];\n\n  /**\n   * Additional features to add to the test app.\n   */\n  features?: FrontendFeature[];\n\n  /**\n   * Initial route entries to use for the router.\n   */\n  initialRouteEntries?: string[];\n};\n\nconst NavItem = (props: {\n  routeRef: RouteRef<undefined>;\n  title: string;\n  icon: IconComponent;\n}) => {\n  const { routeRef, title, icon: Icon } = props;\n  const link = useRouteRef(routeRef);\n  if (!link) {\n    return null;\n  }\n  return (\n    <li>\n      <Link to={link()}>\n        <Icon /> {title}\n      </Link>\n    </li>\n  );\n};\n\nconst appPluginOverride = appPlugin.withOverrides({\n  extensions: [\n    appPlugin.getExtension('sign-in-page:app').override({\n      disabled: true,\n    }),\n    appPlugin.getExtension('app/nav').override({\n      output: [coreExtensionData.reactElement],\n      factory(_originalFactory, { inputs }) {\n        return [\n          coreExtensionData.reactElement(\n            <nav>\n              <ul>\n                {inputs.items.map((item, index) => {\n                  const { icon, title, routeRef } = item.get(\n                    NavItemBlueprint.dataRefs.target,\n                  );\n\n                  return (\n                    <NavItem\n                      key={index}\n                      icon={icon}\n                      title={title}\n                      routeRef={routeRef}\n                    />\n                  );\n                })}\n              </ul>\n            </nav>,\n          ),\n        ];\n      },\n    }),\n  ],\n});\n\n/**\n * @public\n * Renders the given element in a test app, for use in unit tests.\n */\nexport function renderInTestApp(\n  element: JSX.Element,\n  options?: TestAppOptions,\n): RenderResult {\n  const extensions: Array<ExtensionDefinition> = [\n    createExtension({\n      attachTo: { id: 'app/routes', input: 'routes' },\n      output: [coreExtensionData.reactElement, coreExtensionData.routePath],\n      factory: () => {\n        return [\n          coreExtensionData.reactElement(element),\n          coreExtensionData.routePath('/'),\n        ];\n      },\n    }),\n    RouterBlueprint.make({\n      params: {\n        Component: ({ children }) => (\n          <MemoryRouter initialEntries={options?.initialRouteEntries}>\n            {children}\n          </MemoryRouter>\n        ),\n      },\n    }),\n  ];\n\n  if (options?.mountedRoutes) {\n    for (const [path, routeRef] of Object.entries(options.mountedRoutes)) {\n      // TODO(Rugvip): add support for external route refs\n      extensions.push(\n        createExtension({\n          kind: 'test-route',\n          name: path,\n          attachTo: { id: 'app/root', input: 'elements' },\n          output: [\n            coreExtensionData.reactElement,\n            coreExtensionData.routePath,\n            coreExtensionData.routeRef,\n          ],\n          factory: () => [\n            coreExtensionData.reactElement(<Fragment />),\n            coreExtensionData.routePath(path),\n            coreExtensionData.routeRef(routeRef),\n          ],\n        }),\n      );\n    }\n  }\n\n  if (options?.extensions) {\n    extensions.push(...options.extensions);\n  }\n\n  const features: FrontendFeature[] = [\n    createFrontendPlugin({\n      pluginId: 'test',\n      extensions,\n    }),\n    appPluginOverride,\n  ];\n\n  if (options?.features) {\n    features.push(...options.features);\n  }\n\n  const app = createSpecializedApp({\n    features,\n    config: ConfigReader.fromConfigs([\n      {\n        context: 'render-config',\n        data: options?.config ?? DEFAULT_MOCK_CONFIG,\n      },\n    ]),\n  });\n\n  return render(\n    app.tree.root.instance!.getData(coreExtensionData.reactElement),\n  );\n}\n"],"names":[],"mappings":"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"}