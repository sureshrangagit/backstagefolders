{"version":3,"file":"MembersListCard.esm.js","sources":["../../../../../src/components/Cards/Group/MembersList/MembersListCard.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  DEFAULT_NAMESPACE,\n  GroupEntity,\n  UserEntity,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport {\n  catalogApiRef,\n  useEntity,\n  EntityRefLink,\n} from '@backstage/plugin-catalog-react';\nimport Box from '@material-ui/core/Box';\nimport Grid from '@material-ui/core/Grid';\nimport Switch from '@material-ui/core/Switch';\nimport Typography from '@material-ui/core/Typography';\nimport { createStyles, makeStyles, Theme } from '@material-ui/core/styles';\nimport Pagination from '@material-ui/lab/Pagination';\nimport { useState, ChangeEvent } from 'react';\nimport useAsync from 'react-use/esm/useAsync';\n\nimport {\n  Avatar,\n  InfoCard,\n  Progress,\n  ResponseErrorPanel,\n  Link,\n  OverflowTooltip,\n} from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\nimport {\n  getAllDesendantMembersForGroupEntity,\n  removeDuplicateEntitiesFrom,\n} from '../../../../helpers/helpers';\nimport { EntityRelationAggregation } from '../../types';\nimport { useTranslationRef } from '@backstage/frontend-plugin-api';\nimport { orgTranslationRef } from '../../../../translation';\n\n/** @public */\nexport type MemberComponentClassKey = 'card' | 'avatar';\n\nconst useStyles = makeStyles(\n  (theme: Theme) =>\n    createStyles({\n      card: {\n        border: `1px solid ${theme.palette.divider}`,\n        boxShadow: theme.shadows[2],\n        borderRadius: '4px',\n        overflow: 'visible',\n        position: 'relative',\n        margin: theme.spacing(4, 1, 1),\n        flex: '1',\n        minWidth: '0px',\n      },\n      avatar: {\n        position: 'absolute',\n        top: '-2rem',\n      },\n    }),\n  { name: 'PluginOrgMemberComponent' },\n);\n\nconst MemberComponent = (props: { member: UserEntity }) => {\n  const classes = useStyles();\n  const {\n    metadata: { name: metaName, description },\n    spec: { profile },\n  } = props.member;\n  const displayName = profile?.displayName ?? metaName;\n\n  return (\n    <Box className={classes.card}>\n      <Box\n        display=\"flex\"\n        flexDirection=\"column\"\n        m={3}\n        alignItems=\"center\"\n        justifyContent=\"center\"\n      >\n        <Avatar\n          displayName={displayName}\n          picture={profile?.picture}\n          classes={classes}\n        />\n        <Box\n          pt={2}\n          sx={{\n            width: '100%',\n          }}\n          textAlign=\"center\"\n        >\n          <Typography variant=\"h6\">\n            <EntityRefLink\n              data-testid=\"user-link\"\n              entityRef={props.member}\n              title={displayName}\n            />\n          </Typography>\n          {profile?.email && (\n            <Link to={`mailto:${profile.email}`}>\n              <OverflowTooltip text={profile.email} />\n            </Link>\n          )}\n          {description && (\n            <Typography variant=\"subtitle2\">\n              <OverflowTooltip text={description} line={5} />\n            </Typography>\n          )}\n        </Box>\n      </Box>\n    </Box>\n  );\n};\n\n/** @public */\nexport type MembersListCardClassKey = 'root' | 'cardContent' | 'memberList';\n\nconst useListStyles = makeStyles(\n  theme => ({\n    root: {\n      height: '100%',\n    },\n    cardContent: {\n      overflow: 'auto',\n    },\n    memberList: {\n      display: 'grid',\n      gap: theme.spacing(1.5),\n      gridTemplateColumns: `repeat(auto-fit, minmax(auto, ${theme.spacing(\n        34,\n      )}px))`,\n    },\n  }),\n  { name: 'PluginOrgMembersListCardComponent' },\n);\n\n/** @public */\nexport const MembersListCard = (props: {\n  memberDisplayTitle?: string;\n  pageSize?: number;\n  showAggregateMembersToggle?: boolean;\n  relationType?: string;\n  /** @deprecated Please use `relationAggregation` instead */\n  relationsType?: EntityRelationAggregation;\n  relationAggregation?: EntityRelationAggregation;\n}) => {\n  const { t } = useTranslationRef(orgTranslationRef);\n  const {\n    memberDisplayTitle = t('membersListCard.title'),\n    pageSize = 50,\n    showAggregateMembersToggle,\n    relationType = 'memberof',\n  } = props;\n  const relationAggregation =\n    props.relationAggregation ?? props.relationsType ?? 'direct';\n  const classes = useListStyles();\n\n  const { entity: groupEntity } = useEntity<GroupEntity>();\n  const {\n    metadata: { name: groupName, namespace: grpNamespace },\n    spec: { profile },\n  } = groupEntity;\n  const catalogApi = useApi(catalogApiRef);\n\n  const displayName = profile?.displayName ?? groupName;\n\n  const groupNamespace = grpNamespace || DEFAULT_NAMESPACE;\n\n  const [page, setPage] = useState(1);\n  const pageChange = (_: ChangeEvent<unknown>, pageIndex: number) => {\n    setPage(pageIndex);\n  };\n\n  const [showAggregateMembers, setShowAggregateMembers] = useState(\n    relationAggregation === 'aggregated',\n  );\n\n  const { loading: loadingDescendantMembers, value: descendantMembers } =\n    useAsync(async () => {\n      if (!showAggregateMembers) {\n        return [] as UserEntity[];\n      }\n\n      return await getAllDesendantMembersForGroupEntity(\n        groupEntity,\n        catalogApi,\n        relationType,\n      );\n    }, [catalogApi, groupEntity, showAggregateMembers]);\n  const {\n    loading,\n    error,\n    value: directMembers,\n  } = useAsync(async () => {\n    const membersList = await catalogApi.getEntities({\n      filter: {\n        kind: 'User',\n        [`relations.${relationType.toLocaleLowerCase('en-US')}`]: [\n          stringifyEntityRef({\n            kind: 'group',\n            namespace: groupNamespace.toLocaleLowerCase('en-US'),\n            name: groupName.toLocaleLowerCase('en-US'),\n          }),\n        ],\n      },\n    });\n\n    return membersList.items as UserEntity[];\n  }, [catalogApi, groupEntity]);\n\n  const members = removeDuplicateEntitiesFrom(\n    [\n      ...(directMembers ?? []),\n      ...(descendantMembers && showAggregateMembers ? descendantMembers : []),\n    ].sort((a, b) =>\n      stringifyEntityRef(a).localeCompare(stringifyEntityRef(b)),\n    ),\n  ) as UserEntity[];\n\n  if (loading) {\n    return <Progress />;\n  } else if (error) {\n    return <ResponseErrorPanel error={error} />;\n  }\n\n  const nbPages = Math.ceil((members?.length || 0) / pageSize);\n  const paginationLabel =\n    nbPages < 2\n      ? ''\n      : t('membersListCard.paginationLabel', {\n          page: String(page),\n          nbPages: String(nbPages),\n        });\n\n  const pagination = (\n    <Pagination\n      count={nbPages}\n      page={page}\n      onChange={pageChange}\n      showFirstButton\n      showLastButton\n    />\n  );\n\n  let memberList: JSX.Element;\n  if (members && members.length > 0) {\n    memberList = (\n      <Box className={classes.memberList}>\n        {members.slice(pageSize * (page - 1), pageSize * page).map(member => (\n          <MemberComponent member={member} key={stringifyEntityRef(member)} />\n        ))}\n      </Box>\n    );\n  } else {\n    memberList = (\n      <Box p={2}>\n        <Typography>{t('membersListCard.noMembersDescription')}</Typography>\n      </Box>\n    );\n  }\n\n  return (\n    <Grid item className={classes.root}>\n      <InfoCard\n        title={`${memberDisplayTitle} (${\n          members?.length || 0\n        }${paginationLabel})`}\n        subheader={t('membersListCard.subtitle', {\n          groupName: displayName,\n        })}\n        {...(nbPages <= 1 ? {} : { actions: pagination })}\n        className={classes.root}\n        cardClassName={classes.cardContent}\n      >\n        {showAggregateMembersToggle && (\n          <>\n            {t('membersListCard.aggregateMembersToggle.directMembers')}\n            <Switch\n              color=\"primary\"\n              checked={showAggregateMembers}\n              onChange={() => {\n                setShowAggregateMembers(!showAggregateMembers);\n              }}\n              inputProps={{\n                'aria-label': t(\n                  'membersListCard.aggregateMembersToggle.ariaLabel',\n                ),\n              }}\n            />\n            {t('membersListCard.aggregateMembersToggle.aggregatedMembers')}\n          </>\n        )}\n        {showAggregateMembers && loadingDescendantMembers ? (\n          <Progress />\n        ) : (\n          memberList\n        )}\n      </InfoCard>\n    </Grid>\n  );\n};\n"],"names":[],"mappings":"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"}