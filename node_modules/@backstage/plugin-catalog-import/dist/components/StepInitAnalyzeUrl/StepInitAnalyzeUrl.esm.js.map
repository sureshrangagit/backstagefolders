{"version":3,"file":"StepInitAnalyzeUrl.esm.js","sources":["../../../src/components/StepInitAnalyzeUrl/StepInitAnalyzeUrl.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport { useTranslationRef } from '@backstage/frontend-plugin-api';\nimport FormHelperText from '@material-ui/core/FormHelperText';\nimport Grid from '@material-ui/core/Grid';\nimport TextField from '@material-ui/core/TextField';\nimport { useCallback, useState } from 'react';\nimport { useForm } from 'react-hook-form';\n\nimport { AnalyzeResult, catalogImportApiRef } from '../../api';\nimport { catalogImportTranslationRef } from '../../translation';\nimport { NextButton } from '../Buttons';\nimport { asInputRef } from '../helpers';\nimport { ImportFlows, PrepareResult } from '../useImportState';\n\ntype FormData = {\n  url: string;\n};\n\n/**\n * Props for {@link StepInitAnalyzeUrl}.\n *\n * @public\n */\nexport interface StepInitAnalyzeUrlProps {\n  onAnalysis: (\n    flow: ImportFlows,\n    url: string,\n    result: AnalyzeResult,\n    opts?: { prepareResult?: PrepareResult },\n  ) => void;\n  disablePullRequest?: boolean;\n  analysisUrl?: string;\n  exampleLocationUrl?: string;\n}\n\n/**\n * A form that lets the user input a url and analyze it for existing locations or potential entities.\n *\n * @param onAnalysis - is called when the analysis was successful\n * @param analysisUrl - a url that can be used as a default value\n * @param disablePullRequest - if true, repositories without entities will abort the wizard\n * @public\n */\nexport const StepInitAnalyzeUrl = (props: StepInitAnalyzeUrlProps) => {\n  const { t } = useTranslationRef(catalogImportTranslationRef);\n  const {\n    onAnalysis,\n    analysisUrl = '',\n    disablePullRequest = false,\n    exampleLocationUrl = 'https://github.com/backstage/backstage/blob/master/catalog-info.yaml',\n  } = props;\n\n  const errorApi = useApi(errorApiRef);\n  const catalogImportApi = useApi(catalogImportApiRef);\n\n  const {\n    register,\n    handleSubmit,\n    formState: { errors },\n    watch,\n  } = useForm<FormData>({\n    mode: 'onTouched',\n    defaultValues: {\n      url: analysisUrl,\n    },\n  });\n\n  const [submitted, setSubmitted] = useState(false);\n  const [error, setError] = useState<string | undefined>(undefined);\n\n  const handleResult = useCallback(\n    async ({ url }: FormData) => {\n      setSubmitted(true);\n\n      try {\n        const analysisResult = await catalogImportApi.analyzeUrl(url);\n\n        switch (analysisResult.type) {\n          case 'repository':\n            if (\n              !disablePullRequest &&\n              analysisResult.generatedEntities.length > 0\n            ) {\n              onAnalysis('no-location', url, analysisResult);\n            } else {\n              setError(t('stepInitAnalyzeUrl.error.repository'));\n              setSubmitted(false);\n            }\n            break;\n\n          case 'locations': {\n            if (analysisResult.locations.length === 1) {\n              onAnalysis('single-location', url, analysisResult, {\n                prepareResult: analysisResult,\n              });\n            } else if (analysisResult.locations.length > 1) {\n              onAnalysis('multiple-locations', url, analysisResult);\n            } else {\n              setError(t('stepInitAnalyzeUrl.error.locations'));\n              setSubmitted(false);\n            }\n            break;\n          }\n\n          default: {\n            const err = t('stepInitAnalyzeUrl.error.default', {\n              type: (analysisResult as any).type,\n            });\n            setError(err);\n            setSubmitted(false);\n\n            errorApi.post(new Error(err));\n            break;\n          }\n        }\n      } catch (e: any) {\n        setError(e?.data?.error?.message ?? e.message);\n        setSubmitted(false);\n      }\n    },\n    [catalogImportApi, disablePullRequest, errorApi, onAnalysis, t],\n  );\n\n  return (\n    <form onSubmit={handleSubmit(handleResult)}>\n      <TextField\n        {...asInputRef(\n          register('url', {\n            required: true,\n            validate: {\n              httpsValidator: (value: any) =>\n                (typeof value === 'string' &&\n                  value.match(/^http[s]?:\\/\\//) !== null) ||\n                t('stepInitAnalyzeUrl.error.url'),\n            },\n          }),\n        )}\n        fullWidth\n        id=\"url\"\n        label=\"URL\"\n        placeholder={exampleLocationUrl}\n        helperText={t('stepInitAnalyzeUrl.urlHelperText')}\n        margin=\"normal\"\n        variant=\"outlined\"\n        error={Boolean(errors.url)}\n        required\n      />\n      {errors.url && (\n        <FormHelperText error>{errors.url.message}</FormHelperText>\n      )}\n      {error && <FormHelperText error>{error}</FormHelperText>}\n      <Grid container spacing={0}>\n        <NextButton\n          disabled={Boolean(errors.url) || !watch('url')}\n          loading={submitted}\n          type=\"submit\"\n        >\n          {t('stepInitAnalyzeUrl.nextButtonText')}\n        </NextButton>\n      </Grid>\n    </form>\n  );\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AA2Da,MAAA,kBAAA,GAAqB,CAAC,KAAmC,KAAA;AACpE,EAAA,MAAM,EAAE,CAAA,EAAM,GAAA,iBAAA,CAAkB,2BAA2B,CAAA;AAC3D,EAAM,MAAA;AAAA,IACJ,UAAA;AAAA,IACA,WAAc,GAAA,EAAA;AAAA,IACd,kBAAqB,GAAA,KAAA;AAAA,IACrB,kBAAqB,GAAA;AAAA,GACnB,GAAA,KAAA;AAEJ,EAAM,MAAA,QAAA,GAAW,OAAO,WAAW,CAAA;AACnC,EAAM,MAAA,gBAAA,GAAmB,OAAO,mBAAmB,CAAA;AAEnD,EAAM,MAAA;AAAA,IACJ,QAAA;AAAA,IACA,YAAA;AAAA,IACA,SAAA,EAAW,EAAE,MAAO,EAAA;AAAA,IACpB;AAAA,MACE,OAAkB,CAAA;AAAA,IACpB,IAAM,EAAA,WAAA;AAAA,IACN,aAAe,EAAA;AAAA,MACb,GAAK,EAAA;AAAA;AACP,GACD,CAAA;AAED,EAAA,MAAM,CAAC,SAAA,EAAW,YAAY,CAAA,GAAI,SAAS,KAAK,CAAA;AAChD,EAAA,MAAM,CAAC,KAAA,EAAO,QAAQ,CAAA,GAAI,SAA6B,KAAS,CAAA,CAAA;AAEhE,EAAA,MAAM,YAAe,GAAA,WAAA;AAAA,IACnB,OAAO,EAAE,GAAA,EAAoB,KAAA;AAC3B,MAAA,YAAA,CAAa,IAAI,CAAA;AAEjB,MAAI,IAAA;AACF,QAAA,MAAM,cAAiB,GAAA,MAAM,gBAAiB,CAAA,UAAA,CAAW,GAAG,CAAA;AAE5D,QAAA,QAAQ,eAAe,IAAM;AAAA,UAC3B,KAAK,YAAA;AACH,YAAA,IACE,CAAC,kBAAA,IACD,cAAe,CAAA,iBAAA,CAAkB,SAAS,CAC1C,EAAA;AACA,cAAW,UAAA,CAAA,aAAA,EAAe,KAAK,cAAc,CAAA;AAAA,aACxC,MAAA;AACL,cAAS,QAAA,CAAA,CAAA,CAAE,qCAAqC,CAAC,CAAA;AACjD,cAAA,YAAA,CAAa,KAAK,CAAA;AAAA;AAEpB,YAAA;AAAA,UAEF,KAAK,WAAa,EAAA;AAChB,YAAI,IAAA,cAAA,CAAe,SAAU,CAAA,MAAA,KAAW,CAAG,EAAA;AACzC,cAAW,UAAA,CAAA,iBAAA,EAAmB,KAAK,cAAgB,EAAA;AAAA,gBACjD,aAAe,EAAA;AAAA,eAChB,CAAA;AAAA,aACQ,MAAA,IAAA,cAAA,CAAe,SAAU,CAAA,MAAA,GAAS,CAAG,EAAA;AAC9C,cAAW,UAAA,CAAA,oBAAA,EAAsB,KAAK,cAAc,CAAA;AAAA,aAC/C,MAAA;AACL,cAAS,QAAA,CAAA,CAAA,CAAE,oCAAoC,CAAC,CAAA;AAChD,cAAA,YAAA,CAAa,KAAK,CAAA;AAAA;AAEpB,YAAA;AAAA;AACF,UAEA,SAAS;AACP,YAAM,MAAA,GAAA,GAAM,EAAE,kCAAoC,EAAA;AAAA,cAChD,MAAO,cAAuB,CAAA;AAAA,aAC/B,CAAA;AACD,YAAA,QAAA,CAAS,GAAG,CAAA;AACZ,YAAA,YAAA,CAAa,KAAK,CAAA;AAElB,YAAA,QAAA,CAAS,IAAK,CAAA,IAAI,KAAM,CAAA,GAAG,CAAC,CAAA;AAC5B,YAAA;AAAA;AACF;AACF,eACO,CAAQ,EAAA;AACf,QAAA,QAAA,CAAS,CAAG,EAAA,IAAA,EAAM,KAAO,EAAA,OAAA,IAAW,EAAE,OAAO,CAAA;AAC7C,QAAA,YAAA,CAAa,KAAK,CAAA;AAAA;AACpB,KACF;AAAA,IACA,CAAC,gBAAA,EAAkB,kBAAoB,EAAA,QAAA,EAAU,YAAY,CAAC;AAAA,GAChE;AAEA,EAAA,uBACG,IAAA,CAAA,MAAA,EAAA,EAAK,QAAU,EAAA,YAAA,CAAa,YAAY,CACvC,EAAA,QAAA,EAAA;AAAA,oBAAA,GAAA;AAAA,MAAC,SAAA;AAAA,MAAA;AAAA,QACE,GAAG,UAAA;AAAA,UACF,SAAS,KAAO,EAAA;AAAA,YACd,QAAU,EAAA,IAAA;AAAA,YACV,QAAU,EAAA;AAAA,cACR,cAAgB,EAAA,CAAC,KACd,KAAA,OAAO,KAAU,KAAA,QAAA,IAChB,KAAM,CAAA,KAAA,CAAM,gBAAgB,CAAA,KAAM,IACpC,IAAA,CAAA,CAAE,8BAA8B;AAAA;AACpC,WACD;AAAA,SACH;AAAA,QACA,SAAS,EAAA,IAAA;AAAA,QACT,EAAG,EAAA,KAAA;AAAA,QACH,KAAM,EAAA,KAAA;AAAA,QACN,WAAa,EAAA,kBAAA;AAAA,QACb,UAAA,EAAY,EAAE,kCAAkC,CAAA;AAAA,QAChD,MAAO,EAAA,QAAA;AAAA,QACP,OAAQ,EAAA,UAAA;AAAA,QACR,KAAA,EAAO,OAAQ,CAAA,MAAA,CAAO,GAAG,CAAA;AAAA,QACzB,QAAQ,EAAA;AAAA;AAAA,KACV;AAAA,IACC,MAAA,CAAO,uBACL,GAAA,CAAA,cAAA,EAAA,EAAe,OAAK,IAAE,EAAA,QAAA,EAAA,MAAA,CAAO,IAAI,OAAQ,EAAA,CAAA;AAAA,IAE3C,KAAS,oBAAA,GAAA,CAAC,cAAe,EAAA,EAAA,KAAA,EAAK,MAAE,QAAM,EAAA,KAAA,EAAA,CAAA;AAAA,oBACtC,GAAA,CAAA,IAAA,EAAA,EAAK,SAAS,EAAA,IAAA,EAAC,SAAS,CACvB,EAAA,QAAA,kBAAA,GAAA;AAAA,MAAC,UAAA;AAAA,MAAA;AAAA,QACC,UAAU,OAAQ,CAAA,MAAA,CAAO,GAAG,CAAK,IAAA,CAAC,MAAM,KAAK,CAAA;AAAA,QAC7C,OAAS,EAAA,SAAA;AAAA,QACT,IAAK,EAAA,QAAA;AAAA,QAEJ,YAAE,mCAAmC;AAAA;AAAA,KAE1C,EAAA;AAAA,GACF,EAAA,CAAA;AAEJ;;;;"}