{"version":3,"file":"StepPrepareCreatePullRequest.esm.js","sources":["../../../src/components/StepPrepareCreatePullRequest/StepPrepareCreatePullRequest.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Entity } from '@backstage/catalog-model';\nimport { errorApiRef, useApi } from '@backstage/core-plugin-api';\nimport { assertError } from '@backstage/errors';\nimport { useTranslationRef } from '@backstage/frontend-plugin-api';\nimport {\n  catalogApiRef,\n  humanizeEntityRef,\n} from '@backstage/plugin-catalog-react';\nimport Box from '@material-ui/core/Box';\nimport FormHelperText from '@material-ui/core/FormHelperText';\nimport Grid from '@material-ui/core/Grid';\nimport Typography from '@material-ui/core/Typography';\nimport { makeStyles } from '@material-ui/core/styles';\nimport { ReactNode, useCallback, useEffect, useState } from 'react';\nimport { NestedValue, UseFormReturn } from 'react-hook-form';\nimport useAsync from 'react-use/esm/useAsync';\nimport YAML from 'yaml';\n\nimport { AnalyzeResult, catalogImportApiRef } from '../../api';\nimport { useCatalogFilename } from '../../hooks';\nimport { catalogImportTranslationRef } from '../../translation';\nimport { PartialEntity } from '../../types';\nimport { BackButton, NextButton } from '../Buttons';\nimport { PrepareResult } from '../useImportState';\nimport { PreparePullRequestForm } from './PreparePullRequestForm';\nimport { PreviewCatalogInfoComponent } from './PreviewCatalogInfoComponent';\nimport { PreviewPullRequestComponent } from './PreviewPullRequestComponent';\n\nconst useStyles = makeStyles(theme => ({\n  previewCard: {\n    marginTop: theme.spacing(1),\n  },\n  previewCardContent: {\n    paddingTop: 0,\n  },\n}));\n\ntype FormData = {\n  title: string;\n  body: string;\n  componentName: string;\n  owner: string;\n  useCodeowners: boolean;\n};\n\n/**\n * Helper for unpacking NestedValue into the underlying type.\n *\n * @public\n * @deprecated This is a copy of the type from react-hook-form, and will be removed in a future release\n */\nexport type UnpackNestedValue<T> = T extends NestedValue<infer U>\n  ? U\n  : T extends Date | FileList | File | Blob\n  ? T\n  : T extends object\n  ? {\n      [K in keyof T]: UnpackNestedValue<T[K]>;\n    }\n  : T;\n\n/**\n * Props for {@link StepPrepareCreatePullRequest}.\n *\n * @public\n */\nexport interface StepPrepareCreatePullRequestProps {\n  analyzeResult: Extract<AnalyzeResult, { type: 'repository' }>;\n  onPrepare: (\n    result: PrepareResult,\n    opts?: { notRepeatable?: boolean },\n  ) => void;\n  onGoBack?: () => void;\n\n  renderFormFields: (\n    props: Pick<\n      UseFormReturn<FormData>,\n      'register' | 'setValue' | 'formState'\n    > & {\n      values: UnpackNestedValue<FormData>;\n      groups: string[];\n      groupsLoading: boolean;\n    },\n  ) => ReactNode;\n}\n\nexport function generateEntities(\n  entities: PartialEntity[],\n  componentName: string,\n  owner?: string,\n): Entity[] {\n  return entities.map(e => ({\n    ...e,\n    apiVersion: e.apiVersion!,\n    kind: e.kind!,\n    metadata: {\n      ...e.metadata,\n      name: componentName,\n    },\n    spec: {\n      ...e.spec,\n      ...(owner ? { owner } : {}),\n    },\n  }));\n}\n\n/**\n * Prepares a pull request.\n *\n * @public\n */\nexport const StepPrepareCreatePullRequest = (\n  props: StepPrepareCreatePullRequestProps,\n) => {\n  const { analyzeResult, onPrepare, onGoBack, renderFormFields } = props;\n\n  const { t } = useTranslationRef(catalogImportTranslationRef);\n  const classes = useStyles();\n  const catalogApi = useApi(catalogApiRef);\n  const catalogImportApi = useApi(catalogImportApiRef);\n  const errorApi = useApi(errorApiRef);\n\n  const [submitted, setSubmitted] = useState(false);\n  const [error, setError] = useState<string>();\n\n  const catalogFilename = useCatalogFilename();\n\n  const {\n    loading: prDefaultsLoading,\n    value: prDefaults,\n    error: prDefaultsError,\n  } = useAsync(\n    () => catalogImportApi.preparePullRequest!(),\n    [catalogImportApi.preparePullRequest],\n  );\n\n  useEffect(() => {\n    if (prDefaultsError) {\n      errorApi.post(prDefaultsError);\n    }\n  }, [prDefaultsError, errorApi]);\n\n  const { loading: groupsLoading, value: groups } = useAsync(async () => {\n    const groupEntities = await catalogApi.getEntities({\n      filter: { kind: 'group' },\n    });\n\n    return groupEntities.items\n      .map(e => humanizeEntityRef(e, { defaultKind: 'group' }))\n      .sort();\n  });\n\n  const handleResult = useCallback(\n    async (data: FormData) => {\n      setSubmitted(true);\n\n      try {\n        const pr = await catalogImportApi.submitPullRequest({\n          repositoryUrl: analyzeResult.url,\n          title: data.title,\n          body: data.body,\n          fileContent: generateEntities(\n            analyzeResult.generatedEntities,\n            data.componentName,\n            data.owner,\n          )\n            .map(e => YAML.stringify(e))\n            .join('---\\n'),\n        });\n\n        onPrepare(\n          {\n            type: 'repository',\n            url: analyzeResult.url,\n            integrationType: analyzeResult.integrationType,\n            pullRequest: {\n              url: pr.link,\n            },\n            locations: [\n              {\n                target: pr.location,\n                entities: generateEntities(\n                  analyzeResult.generatedEntities,\n                  data.componentName,\n                  data.owner,\n                ).map(e => ({\n                  kind: e.kind,\n                  namespace: e.metadata.namespace!,\n                  name: e.metadata.name,\n                })),\n              },\n            ],\n          },\n          { notRepeatable: true },\n        );\n      } catch (e) {\n        assertError(e);\n        setError(e.message);\n        setSubmitted(false);\n      }\n    },\n    [\n      analyzeResult.generatedEntities,\n      analyzeResult.integrationType,\n      analyzeResult.url,\n      catalogImportApi,\n      onPrepare,\n    ],\n  );\n\n  return (\n    <>\n      <Typography>\n        {t('stepPrepareCreatePullRequest.description', {\n          integrationType: analyzeResult.integrationType,\n          catalogFilename: <code>{catalogFilename}</code>,\n        })}\n      </Typography>\n\n      {!prDefaultsLoading && (\n        <PreparePullRequestForm<FormData>\n          onSubmit={handleResult}\n          defaultValues={{\n            title: prDefaults?.title ?? '',\n            body: prDefaults?.body ?? '',\n            owner:\n              (analyzeResult.generatedEntities[0]?.spec?.owner as string) || '',\n            componentName:\n              analyzeResult.generatedEntities[0]?.metadata?.name || '',\n            useCodeowners: false,\n          }}\n          render={({ values, formState, register, setValue }) => (\n            <>\n              {renderFormFields({\n                values,\n                formState,\n                register,\n                setValue,\n                groups: groups ?? [],\n                groupsLoading,\n              })}\n\n              <Box marginTop={2}>\n                <Typography variant=\"h6\">\n                  {t('stepPrepareCreatePullRequest.previewPr.title')}\n                </Typography>\n              </Box>\n\n              <PreviewPullRequestComponent\n                title={values.title}\n                description={values.body}\n                classes={{\n                  card: classes.previewCard,\n                  cardContent: classes.previewCardContent,\n                }}\n              />\n\n              <Box marginTop={2} marginBottom={1}>\n                <Typography variant=\"h6\">\n                  {t('stepPrepareCreatePullRequest.previewCatalogInfo.title')}\n                </Typography>\n              </Box>\n\n              <PreviewCatalogInfoComponent\n                entities={generateEntities(\n                  analyzeResult.generatedEntities,\n                  values.componentName,\n                  values.owner,\n                )}\n                repositoryUrl={analyzeResult.url}\n                classes={{\n                  card: classes.previewCard,\n                  cardContent: classes.previewCardContent,\n                }}\n              />\n\n              {error && <FormHelperText error>{error}</FormHelperText>}\n\n              <Grid container spacing={0}>\n                {onGoBack && (\n                  <BackButton onClick={onGoBack} disabled={submitted} />\n                )}\n                <NextButton\n                  type=\"submit\"\n                  disabled={Boolean(\n                    formState.errors.title ||\n                      formState.errors.body ||\n                      formState.errors.owner,\n                  )}\n                  loading={submitted}\n                >\n                  {t('stepPrepareCreatePullRequest.nextButtonText')}\n                </NextButton>\n              </Grid>\n            </>\n          )}\n        />\n      )}\n    </>\n  );\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AA4CA,MAAM,SAAA,GAAY,WAAW,CAAU,KAAA,MAAA;AAAA,EACrC,WAAa,EAAA;AAAA,IACX,SAAA,EAAW,KAAM,CAAA,OAAA,CAAQ,CAAC;AAAA,GAC5B;AAAA,EACA,kBAAoB,EAAA;AAAA,IAClB,UAAY,EAAA;AAAA;AAEhB,CAAE,CAAA,CAAA;AAmDc,SAAA,gBAAA,CACd,QACA,EAAA,aAAA,EACA,KACU,EAAA;AACV,EAAO,OAAA,QAAA,CAAS,IAAI,CAAM,CAAA,MAAA;AAAA,IACxB,GAAG,CAAA;AAAA,IACH,YAAY,CAAE,CAAA,UAAA;AAAA,IACd,MAAM,CAAE,CAAA,IAAA;AAAA,IACR,QAAU,EAAA;AAAA,MACR,GAAG,CAAE,CAAA,QAAA;AAAA,MACL,IAAM,EAAA;AAAA,KACR;AAAA,IACA,IAAM,EAAA;AAAA,MACJ,GAAG,CAAE,CAAA,IAAA;AAAA,MACL,GAAI,KAAA,GAAQ,EAAE,KAAA,KAAU;AAAC;AAC3B,GACA,CAAA,CAAA;AACJ;AAOa,MAAA,4BAAA,GAA+B,CAC1C,KACG,KAAA;AACH,EAAA,MAAM,EAAE,aAAA,EAAe,SAAW,EAAA,QAAA,EAAU,kBAAqB,GAAA,KAAA;AAEjE,EAAA,MAAM,EAAE,CAAA,EAAM,GAAA,iBAAA,CAAkB,2BAA2B,CAAA;AAC3D,EAAA,MAAM,UAAU,SAAU,EAAA;AAC1B,EAAM,MAAA,UAAA,GAAa,OAAO,aAAa,CAAA;AACvC,EAAM,MAAA,gBAAA,GAAmB,OAAO,mBAAmB,CAAA;AACnD,EAAM,MAAA,QAAA,GAAW,OAAO,WAAW,CAAA;AAEnC,EAAA,MAAM,CAAC,SAAA,EAAW,YAAY,CAAA,GAAI,SAAS,KAAK,CAAA;AAChD,EAAA,MAAM,CAAC,KAAA,EAAO,QAAQ,CAAA,GAAI,QAAiB,EAAA;AAE3C,EAAA,MAAM,kBAAkB,kBAAmB,EAAA;AAE3C,EAAM,MAAA;AAAA,IACJ,OAAS,EAAA,iBAAA;AAAA,IACT,KAAO,EAAA,UAAA;AAAA,IACP,KAAO,EAAA;AAAA,GACL,GAAA,QAAA;AAAA,IACF,MAAM,iBAAiB,kBAAoB,EAAA;AAAA,IAC3C,CAAC,iBAAiB,kBAAkB;AAAA,GACtC;AAEA,EAAA,SAAA,CAAU,MAAM;AACd,IAAA,IAAI,eAAiB,EAAA;AACnB,MAAA,QAAA,CAAS,KAAK,eAAe,CAAA;AAAA;AAC/B,GACC,EAAA,CAAC,eAAiB,EAAA,QAAQ,CAAC,CAAA;AAE9B,EAAA,MAAM,EAAE,OAAS,EAAA,aAAA,EAAe,OAAO,MAAO,EAAA,GAAI,SAAS,YAAY;AACrE,IAAM,MAAA,aAAA,GAAgB,MAAM,UAAA,CAAW,WAAY,CAAA;AAAA,MACjD,MAAA,EAAQ,EAAE,IAAA,EAAM,OAAQ;AAAA,KACzB,CAAA;AAED,IAAA,OAAO,aAAc,CAAA,KAAA,CAClB,GAAI,CAAA,CAAA,CAAA,KAAK,iBAAkB,CAAA,CAAA,EAAG,EAAE,WAAA,EAAa,OAAQ,EAAC,CAAC,CAAA,CACvD,IAAK,EAAA;AAAA,GACT,CAAA;AAED,EAAA,MAAM,YAAe,GAAA,WAAA;AAAA,IACnB,OAAO,IAAmB,KAAA;AACxB,MAAA,YAAA,CAAa,IAAI,CAAA;AAEjB,MAAI,IAAA;AACF,QAAM,MAAA,EAAA,GAAK,MAAM,gBAAA,CAAiB,iBAAkB,CAAA;AAAA,UAClD,eAAe,aAAc,CAAA,GAAA;AAAA,UAC7B,OAAO,IAAK,CAAA,KAAA;AAAA,UACZ,MAAM,IAAK,CAAA,IAAA;AAAA,UACX,WAAa,EAAA,gBAAA;AAAA,YACX,aAAc,CAAA,iBAAA;AAAA,YACd,IAAK,CAAA,aAAA;AAAA,YACL,IAAK,CAAA;AAAA,WACP,CACG,IAAI,CAAK,CAAA,KAAA,IAAA,CAAK,UAAU,CAAC,CAAC,CAC1B,CAAA,IAAA,CAAK,OAAO;AAAA,SAChB,CAAA;AAED,QAAA,SAAA;AAAA,UACE;AAAA,YACE,IAAM,EAAA,YAAA;AAAA,YACN,KAAK,aAAc,CAAA,GAAA;AAAA,YACnB,iBAAiB,aAAc,CAAA,eAAA;AAAA,YAC/B,WAAa,EAAA;AAAA,cACX,KAAK,EAAG,CAAA;AAAA,aACV;AAAA,YACA,SAAW,EAAA;AAAA,cACT;AAAA,gBACE,QAAQ,EAAG,CAAA,QAAA;AAAA,gBACX,QAAU,EAAA,gBAAA;AAAA,kBACR,aAAc,CAAA,iBAAA;AAAA,kBACd,IAAK,CAAA,aAAA;AAAA,kBACL,IAAK,CAAA;AAAA,iBACP,CAAE,IAAI,CAAM,CAAA,MAAA;AAAA,kBACV,MAAM,CAAE,CAAA,IAAA;AAAA,kBACR,SAAA,EAAW,EAAE,QAAS,CAAA,SAAA;AAAA,kBACtB,IAAA,EAAM,EAAE,QAAS,CAAA;AAAA,iBACjB,CAAA;AAAA;AACJ;AACF,WACF;AAAA,UACA,EAAE,eAAe,IAAK;AAAA,SACxB;AAAA,eACO,CAAG,EAAA;AACV,QAAA,WAAA,CAAY,CAAC,CAAA;AACb,QAAA,QAAA,CAAS,EAAE,OAAO,CAAA;AAClB,QAAA,YAAA,CAAa,KAAK,CAAA;AAAA;AACpB,KACF;AAAA,IACA;AAAA,MACE,aAAc,CAAA,iBAAA;AAAA,MACd,aAAc,CAAA,eAAA;AAAA,MACd,aAAc,CAAA,GAAA;AAAA,MACd,gBAAA;AAAA,MACA;AAAA;AACF,GACF;AAEA,EAAA,uBAEI,IAAA,CAAA,QAAA,EAAA,EAAA,QAAA,EAAA;AAAA,oBAAC,GAAA,CAAA,UAAA,EAAA,EACE,YAAE,0CAA4C,EAAA;AAAA,MAC7C,iBAAiB,aAAc,CAAA,eAAA;AAAA,MAC/B,eAAA,kBAAkB,GAAA,CAAA,MAAA,EAAA,EAAM,QAAgB,EAAA,eAAA,EAAA;AAAA,KACzC,CACH,EAAA,CAAA;AAAA,IAEC,CAAC,iBACA,oBAAA,GAAA;AAAA,MAAC,sBAAA;AAAA,MAAA;AAAA,QACC,QAAU,EAAA,YAAA;AAAA,QACV,aAAe,EAAA;AAAA,UACb,KAAA,EAAO,YAAY,KAAS,IAAA,EAAA;AAAA,UAC5B,IAAA,EAAM,YAAY,IAAQ,IAAA,EAAA;AAAA,UAC1B,OACG,aAAc,CAAA,iBAAA,CAAkB,CAAC,CAAA,EAAG,MAAM,KAAoB,IAAA,EAAA;AAAA,UACjE,eACE,aAAc,CAAA,iBAAA,CAAkB,CAAC,CAAA,EAAG,UAAU,IAAQ,IAAA,EAAA;AAAA,UACxD,aAAe,EAAA;AAAA,SACjB;AAAA,QACA,MAAA,EAAQ,CAAC,EAAE,MAAA,EAAQ,WAAW,QAAU,EAAA,QAAA,uBAEnC,IAAA,CAAA,QAAA,EAAA,EAAA,QAAA,EAAA;AAAA,UAAiB,gBAAA,CAAA;AAAA,YAChB,MAAA;AAAA,YACA,SAAA;AAAA,YACA,QAAA;AAAA,YACA,QAAA;AAAA,YACA,MAAA,EAAQ,UAAU,EAAC;AAAA,YACnB;AAAA,WACD,CAAA;AAAA,0BAED,GAAA,CAAC,GAAI,EAAA,EAAA,SAAA,EAAW,CACd,EAAA,QAAA,kBAAA,GAAA,CAAC,UAAW,EAAA,EAAA,OAAA,EAAQ,IACjB,EAAA,QAAA,EAAA,CAAA,CAAE,8CAA8C,CAAA,EACnD,CACF,EAAA,CAAA;AAAA,0BAEA,GAAA;AAAA,YAAC,2BAAA;AAAA,YAAA;AAAA,cACC,OAAO,MAAO,CAAA,KAAA;AAAA,cACd,aAAa,MAAO,CAAA,IAAA;AAAA,cACpB,OAAS,EAAA;AAAA,gBACP,MAAM,OAAQ,CAAA,WAAA;AAAA,gBACd,aAAa,OAAQ,CAAA;AAAA;AACvB;AAAA,WACF;AAAA,0BAEC,GAAA,CAAA,GAAA,EAAA,EAAI,SAAW,EAAA,CAAA,EAAG,YAAc,EAAA,CAAA,EAC/B,QAAC,kBAAA,GAAA,CAAA,UAAA,EAAA,EAAW,OAAQ,EAAA,IAAA,EACjB,QAAE,EAAA,CAAA,CAAA,uDAAuD,GAC5D,CACF,EAAA,CAAA;AAAA,0BAEA,GAAA;AAAA,YAAC,2BAAA;AAAA,YAAA;AAAA,cACC,QAAU,EAAA,gBAAA;AAAA,gBACR,aAAc,CAAA,iBAAA;AAAA,gBACd,MAAO,CAAA,aAAA;AAAA,gBACP,MAAO,CAAA;AAAA,eACT;AAAA,cACA,eAAe,aAAc,CAAA,GAAA;AAAA,cAC7B,OAAS,EAAA;AAAA,gBACP,MAAM,OAAQ,CAAA,WAAA;AAAA,gBACd,aAAa,OAAQ,CAAA;AAAA;AACvB;AAAA,WACF;AAAA,UAEC,KAAS,oBAAA,GAAA,CAAC,cAAe,EAAA,EAAA,KAAA,EAAK,MAAE,QAAM,EAAA,KAAA,EAAA,CAAA;AAAA,0BAEtC,IAAA,CAAA,IAAA,EAAA,EAAK,SAAS,EAAA,IAAA,EAAC,SAAS,CACtB,EAAA,QAAA,EAAA;AAAA,YAAA,QAAA,oBACE,GAAA,CAAA,UAAA,EAAA,EAAW,OAAS,EAAA,QAAA,EAAU,UAAU,SAAW,EAAA,CAAA;AAAA,4BAEtD,GAAA;AAAA,cAAC,UAAA;AAAA,cAAA;AAAA,gBACC,IAAK,EAAA,QAAA;AAAA,gBACL,QAAU,EAAA,OAAA;AAAA,kBACR,UAAU,MAAO,CAAA,KAAA,IACf,UAAU,MAAO,CAAA,IAAA,IACjB,UAAU,MAAO,CAAA;AAAA,iBACrB;AAAA,gBACA,OAAS,EAAA,SAAA;AAAA,gBAER,YAAE,6CAA6C;AAAA;AAAA;AAClD,WACF,EAAA;AAAA,SACF,EAAA;AAAA;AAAA;AAEJ,GAEJ,EAAA,CAAA;AAEJ;;;;"}