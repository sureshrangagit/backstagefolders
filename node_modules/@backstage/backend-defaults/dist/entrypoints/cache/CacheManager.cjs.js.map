{"version":3,"file":"CacheManager.cjs.js","sources":["../../../src/entrypoints/cache/CacheManager.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  CacheService,\n  CacheServiceOptions,\n  LoggerService,\n  RootConfigService,\n} from '@backstage/backend-plugin-api';\nimport Keyv from 'keyv';\nimport { DefaultCacheClient } from './CacheClient';\nimport {\n  CacheManagerOptions,\n  ttlToMilliseconds,\n  CacheStoreOptions,\n  RedisCacheStoreOptions,\n} from './types';\nimport { durationToMilliseconds } from '@backstage/types';\nimport { readDurationFromConfig } from '@backstage/config';\n\ntype StoreFactory = (pluginId: string, defaultTtl: number | undefined) => Keyv;\n\n/**\n * Implements a Cache Manager which will automatically create new cache clients\n * for plugins when requested. All requested cache clients are created with the\n * connection details provided.\n *\n * @public\n */\nexport class CacheManager {\n  /**\n   * Keys represent supported `backend.cache.store` values, mapped to factories\n   * that return Keyv instances appropriate to the store.\n   */\n  private readonly storeFactories = {\n    redis: this.createRedisStoreFactory(),\n    valkey: this.createValkeyStoreFactory(),\n    memcache: this.createMemcacheStoreFactory(),\n    memory: this.createMemoryStoreFactory(),\n  };\n\n  private readonly logger?: LoggerService;\n  private readonly store: keyof CacheManager['storeFactories'];\n  private readonly connection: string;\n  private readonly errorHandler: CacheManagerOptions['onError'];\n  private readonly defaultTtl?: number;\n  private readonly storeOptions?: CacheStoreOptions;\n\n  /**\n   * Creates a new {@link CacheManager} instance by reading from the `backend`\n   * config section, specifically the `.cache` key.\n   *\n   * @param config - The loaded application configuration.\n   */\n  static fromConfig(\n    config: RootConfigService,\n    options: CacheManagerOptions = {},\n  ): CacheManager {\n    // If no `backend.cache` config is provided, instantiate the CacheManager\n    // with an in-memory cache client.\n    const store = config.getOptionalString('backend.cache.store') || 'memory';\n    const defaultTtlConfig = config.getOptional('backend.cache.defaultTtl');\n    const connectionString =\n      config.getOptionalString('backend.cache.connection') || '';\n    const logger = options.logger?.child({\n      type: 'cacheManager',\n    });\n\n    if (config.has('backend.cache.useRedisSets')) {\n      logger?.warn(\n        \"The 'backend.cache.useRedisSets' configuration key is deprecated and no longer has any effect. The underlying '@keyv/redis' and '@keyv/valkey' libraries no longer support redis sets.\",\n      );\n    }\n\n    let defaultTtl: number | undefined;\n    if (defaultTtlConfig !== undefined) {\n      if (typeof defaultTtlConfig === 'number') {\n        defaultTtl = defaultTtlConfig;\n      } else {\n        defaultTtl = durationToMilliseconds(\n          readDurationFromConfig(config, { key: 'backend.cache.defaultTtl' }),\n        );\n      }\n    }\n\n    // Read store-specific options from config\n    const storeOptions = CacheManager.parseStoreOptions(store, config, logger);\n\n    return new CacheManager(\n      store,\n      connectionString,\n      options.onError,\n      logger,\n      defaultTtl,\n      storeOptions,\n    );\n  }\n\n  /**\n   * Parse store-specific options from configuration.\n   *\n   * @param store - The cache store type ('redis', 'valkey', 'memcache', or 'memory')\n   * @param config - The configuration service\n   * @param logger - Optional logger for warnings\n   * @returns The parsed store options\n   */\n  private static parseStoreOptions(\n    store: string,\n    config: RootConfigService,\n    logger?: LoggerService,\n  ): CacheStoreOptions | undefined {\n    const storeConfigPath = `backend.cache.${store}`;\n\n    if (\n      (store === 'redis' || store === 'valkey') &&\n      config.has(storeConfigPath)\n    ) {\n      return CacheManager.parseRedisOptions(storeConfigPath, config, logger);\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Parse Redis-specific options from configuration.\n   */\n  private static parseRedisOptions(\n    storeConfigPath: string,\n    config: RootConfigService,\n    logger?: LoggerService,\n  ): RedisCacheStoreOptions {\n    const redisOptions: RedisCacheStoreOptions = {};\n    const redisConfig = config.getConfig(storeConfigPath);\n\n    redisOptions.client = {\n      namespace: redisConfig.getOptionalString('client.namespace'),\n      keyPrefixSeparator:\n        redisConfig.getOptionalString('client.keyPrefixSeparator') || ':',\n      clearBatchSize: redisConfig.getOptionalNumber('client.clearBatchSize'),\n      useUnlink: redisConfig.getOptionalBoolean('client.useUnlink'),\n      noNamespaceAffectsAll: redisConfig.getOptionalBoolean(\n        'client.noNamespaceAffectsAll',\n      ),\n    };\n\n    if (redisConfig.has('cluster')) {\n      const clusterConfig = redisConfig.getConfig('cluster');\n\n      if (!clusterConfig.has('rootNodes')) {\n        logger?.warn(\n          `Redis cluster config has no 'rootNodes' key, defaulting to non-clustered mode`,\n        );\n        return redisOptions;\n      }\n\n      redisOptions.cluster = {\n        rootNodes: clusterConfig.get('rootNodes'),\n        defaults: clusterConfig.getOptional('defaults'),\n        minimizeConnections: clusterConfig.getOptionalBoolean(\n          'minimizeConnections',\n        ),\n        useReplicas: clusterConfig.getOptionalBoolean('useReplicas'),\n        maxCommandRedirections: clusterConfig.getOptionalNumber(\n          'maxCommandRedirections',\n        ),\n      };\n    }\n\n    return redisOptions;\n  }\n\n  /** @internal */\n  constructor(\n    store: string,\n    connectionString: string,\n    errorHandler: CacheManagerOptions['onError'],\n    logger?: LoggerService,\n    defaultTtl?: number,\n    storeOptions?: CacheStoreOptions,\n  ) {\n    if (!this.storeFactories.hasOwnProperty(store)) {\n      throw new Error(`Unknown cache store: ${store}`);\n    }\n    this.logger = logger;\n    this.store = store as keyof CacheManager['storeFactories'];\n    this.connection = connectionString;\n    this.errorHandler = errorHandler;\n    this.defaultTtl = defaultTtl;\n    this.storeOptions = storeOptions;\n  }\n\n  /**\n   * Generates a PluginCacheManager for consumption by plugins.\n   *\n   * @param pluginId - The plugin that the cache manager should be created for.\n   *        Plugin names should be unique.\n   */\n  forPlugin(pluginId: string): CacheService {\n    const clientFactory = (options: CacheServiceOptions) => {\n      const ttl = options.defaultTtl ?? this.defaultTtl;\n      return this.getClientWithTtl(\n        pluginId,\n        ttl !== undefined ? ttlToMilliseconds(ttl) : undefined,\n      );\n    };\n\n    return new DefaultCacheClient(clientFactory({}), clientFactory, {});\n  }\n\n  private getClientWithTtl(pluginId: string, ttl: number | undefined): Keyv {\n    return this.storeFactories[this.store](pluginId, ttl);\n  }\n\n  private createRedisStoreFactory(): StoreFactory {\n    const KeyvRedis = require('@keyv/redis').default;\n    const { createCluster } = require('@keyv/redis');\n    const stores: Record<string, typeof KeyvRedis> = {};\n\n    return (pluginId, defaultTtl) => {\n      if (!stores[pluginId]) {\n        const redisOptions = this.storeOptions?.client || {\n          keyPrefixSeparator: ':',\n        };\n        if (this.storeOptions?.cluster) {\n          // Create a Redis cluster\n          const cluster = createCluster(this.storeOptions?.cluster);\n          stores[pluginId] = new KeyvRedis(cluster, redisOptions);\n        } else {\n          // Create a regular Redis connection\n          stores[pluginId] = new KeyvRedis(this.connection, redisOptions);\n        }\n\n        // Always provide an error handler to avoid stopping the process\n        stores[pluginId].on('error', (err: Error) => {\n          this.logger?.error('Failed to create redis cache client', err);\n          this.errorHandler?.(err);\n        });\n      }\n      return new Keyv({\n        namespace: pluginId,\n        ttl: defaultTtl,\n        store: stores[pluginId],\n        emitErrors: false,\n        useKeyPrefix: false,\n      });\n    };\n  }\n\n  private createValkeyStoreFactory(): StoreFactory {\n    const KeyvValkey = require('@keyv/valkey').default;\n    const { createCluster } = require('@keyv/valkey');\n    const stores: Record<string, typeof KeyvValkey> = {};\n\n    return (pluginId, defaultTtl) => {\n      if (!stores[pluginId]) {\n        const valkeyOptions = this.storeOptions?.client || {\n          keyPrefixSeparator: ':',\n        };\n        if (this.storeOptions?.cluster) {\n          // Create a Valkey cluster (Redis cluster under the hood)\n          const cluster = createCluster(this.storeOptions?.cluster);\n          stores[pluginId] = new KeyvValkey(cluster, valkeyOptions);\n        } else {\n          // Create a regular Valkey connection\n          stores[pluginId] = new KeyvValkey(this.connection, valkeyOptions);\n        }\n\n        // Always provide an error handler to avoid stopping the process\n        stores[pluginId].on('error', (err: Error) => {\n          this.logger?.error('Failed to create valkey cache client', err);\n          this.errorHandler?.(err);\n        });\n      }\n      return new Keyv({\n        namespace: pluginId,\n        ttl: defaultTtl,\n        store: stores[pluginId],\n        emitErrors: false,\n        useKeyPrefix: false,\n      });\n    };\n  }\n\n  private createMemcacheStoreFactory(): StoreFactory {\n    const KeyvMemcache = require('@keyv/memcache').default;\n    const stores: Record<string, typeof KeyvMemcache> = {};\n\n    return (pluginId, defaultTtl) => {\n      if (!stores[pluginId]) {\n        stores[pluginId] = new KeyvMemcache(this.connection);\n        // Always provide an error handler to avoid stopping the process\n        stores[pluginId].on('error', (err: Error) => {\n          this.logger?.error('Failed to create memcache cache client', err);\n          this.errorHandler?.(err);\n        });\n      }\n      return new Keyv({\n        namespace: pluginId,\n        ttl: defaultTtl,\n        emitErrors: false,\n        store: stores[pluginId],\n      });\n    };\n  }\n\n  private createMemoryStoreFactory(): StoreFactory {\n    const store = new Map();\n    return (pluginId, defaultTtl) =>\n      new Keyv({\n        namespace: pluginId,\n        ttl: defaultTtl,\n        emitErrors: false,\n        store,\n      });\n  }\n}\n"],"names":["config","durationToMilliseconds","readDurationFromConfig","ttlToMilliseconds","DefaultCacheClient","Keyv"],"mappings":"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"}