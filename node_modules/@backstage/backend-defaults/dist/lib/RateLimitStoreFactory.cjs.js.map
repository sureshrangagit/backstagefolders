{"version":3,"file":"RateLimitStoreFactory.cjs.js","sources":["../../src/lib/RateLimitStoreFactory.ts"],"sourcesContent":["/*\n * Copyright 2024 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Config } from '@backstage/config';\nimport type { Store } from 'express-rate-limit';\nimport { RedisStore } from 'rate-limit-redis';\n\n/**\n * Creates a store for `express-rate-limit` based on the configuration.\n *\n * @internal\n */\nexport class RateLimitStoreFactory {\n  static create(options: {\n    config: Config;\n    prefix?: string;\n  }): Store | undefined {\n    const { config, prefix } = options;\n    const store = config.getOptionalConfig('backend.rateLimit.store');\n    if (!store) {\n      return undefined;\n    }\n    const type = store.getString('type');\n    switch (type) {\n      case 'redis':\n        return this.redis({ store, prefix });\n      case 'memory':\n      default:\n        return undefined;\n    }\n  }\n\n  private static redis(options: { store: Config; prefix?: string }): Store {\n    const { store, prefix } = options;\n    const connectionString = store.getString('connection');\n    const KeyvRedis = require('@keyv/redis').default;\n    const keyv = new KeyvRedis(connectionString);\n    return new RedisStore({\n      prefix,\n      sendCommand: async (...args: string[]) => {\n        const client = await keyv.getClient();\n        return client.sendCommand(args);\n      },\n    });\n  }\n}\n"],"names":["RedisStore"],"mappings":";;;;AAwBO,MAAM,qBAAsB,CAAA;AAAA,EACjC,OAAO,OAAO,OAGQ,EAAA;AACpB,IAAM,MAAA,EAAE,MAAQ,EAAA,MAAA,EAAW,GAAA,OAAA;AAC3B,IAAM,MAAA,KAAA,GAAQ,MAAO,CAAA,iBAAA,CAAkB,yBAAyB,CAAA;AAChE,IAAA,IAAI,CAAC,KAAO,EAAA;AACV,MAAO,OAAA,KAAA,CAAA;AAAA;AAET,IAAM,MAAA,IAAA,GAAO,KAAM,CAAA,SAAA,CAAU,MAAM,CAAA;AACnC,IAAA,QAAQ,IAAM;AAAA,MACZ,KAAK,OAAA;AACH,QAAA,OAAO,IAAK,CAAA,KAAA,CAAM,EAAE,KAAA,EAAO,QAAQ,CAAA;AAAA,MACrC,KAAK,QAAA;AAAA,MACL;AACE,QAAO,OAAA,KAAA,CAAA;AAAA;AACX;AACF,EAEA,OAAe,MAAM,OAAoD,EAAA;AACvE,IAAM,MAAA,EAAE,KAAO,EAAA,MAAA,EAAW,GAAA,OAAA;AAC1B,IAAM,MAAA,gBAAA,GAAmB,KAAM,CAAA,SAAA,CAAU,YAAY,CAAA;AACrD,IAAM,MAAA,SAAA,GAAY,OAAQ,CAAA,aAAa,CAAE,CAAA,OAAA;AACzC,IAAM,MAAA,IAAA,GAAO,IAAI,SAAA,CAAU,gBAAgB,CAAA;AAC3C,IAAA,OAAO,IAAIA,yBAAW,CAAA;AAAA,MACpB,MAAA;AAAA,MACA,WAAA,EAAa,UAAU,IAAmB,KAAA;AACxC,QAAM,MAAA,MAAA,GAAS,MAAM,IAAA,CAAK,SAAU,EAAA;AACpC,QAAO,OAAA,MAAA,CAAO,YAAY,IAAI,CAAA;AAAA;AAChC,KACD,CAAA;AAAA;AAEL;;;;"}