{"version":3,"file":"Router.esm.js","sources":["../../../src/components/Router/Router.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { ComponentType, PropsWithChildren } from 'react';\nimport { Routes, Route, useOutlet } from 'react-router-dom';\n\nimport {\n  FieldExtensionOptions,\n  FormProps,\n  ReviewStepProps,\n  TemplateGroupFilter,\n} from '@backstage/plugin-scaffolder-react';\nimport {\n  ScaffolderTaskOutput,\n  SecretsContextProvider,\n  useCustomFieldExtensions,\n  useCustomLayouts,\n} from '@backstage/plugin-scaffolder-react';\n\nimport { TemplateEntityV1beta3 } from '@backstage/plugin-scaffolder-common';\nimport { DEFAULT_SCAFFOLDER_FIELD_EXTENSIONS } from '../../extensions/default';\n\nimport {\n  actionsRouteRef,\n  editorRouteRef,\n  customFieldsRouteRef,\n  editRouteRef,\n  scaffolderListTaskRouteRef,\n  scaffolderTaskRouteRef,\n  selectedTemplateRouteRef,\n  templateFormRouteRef,\n  templatingExtensionsRouteRef,\n} from '../../routes';\n\nimport { ActionsPage } from '../../components/ActionsPage';\nimport { ListTasksPage } from '../../components/ListTasksPage';\n\nimport {\n  TemplateListPageProps,\n  TemplateWizardPageProps,\n} from '@backstage/plugin-scaffolder/alpha';\nimport { TemplateListPage, TemplateWizardPage } from '../../alpha/components';\nimport { OngoingTask } from '../OngoingTask';\nimport {\n  TemplateFormPage,\n  TemplateIntroPage,\n  TemplateEditorPage,\n  CustomFieldsPage,\n} from '../../alpha/components/TemplateEditorPage';\nimport { RequirePermission } from '@backstage/plugin-permission-react';\nimport {\n  taskReadPermission,\n  templateManagementPermission,\n} from '@backstage/plugin-scaffolder-common/alpha';\nimport { useApp } from '@backstage/core-plugin-api';\nimport { FormField, OpaqueFormField } from '@internal/scaffolder';\nimport { useAsync, useMountEffect } from '@react-hookz/web';\nimport { TemplatingExtensionsPage } from '../TemplatingExtensionsPage';\n\n/**\n * The Props for the Scaffolder Router\n *\n * @public\n */\nexport type RouterProps = {\n  components?: {\n    ReviewStepComponent?: ComponentType<ReviewStepProps>;\n    TemplateCardComponent?: ComponentType<{\n      template: TemplateEntityV1beta3;\n    }>;\n    TaskPageComponent?: ComponentType<PropsWithChildren<{}>>;\n    EXPERIMENTAL_TemplateOutputsComponent?: ComponentType<{\n      output?: ScaffolderTaskOutput;\n    }>;\n    EXPERIMENTAL_TemplateListPageComponent?: ComponentType<TemplateListPageProps>;\n    EXPERIMENTAL_TemplateWizardPageComponent?: ComponentType<TemplateWizardPageProps>;\n  };\n  groups?: TemplateGroupFilter[];\n  templateFilter?: (entity: TemplateEntityV1beta3) => boolean;\n  headerOptions?: {\n    pageTitleOverride?: string;\n    title?: string;\n    subtitle?: string;\n  };\n  defaultPreviewTemplate?: string;\n  formProps?: FormProps;\n  contextMenu?: {\n    /** Whether to show a link to the template editor */\n    editor?: boolean;\n    /** Whether to show a link to the actions documentation */\n    actions?: boolean;\n    /** Whether to show a link to the tasks page */\n    tasks?: boolean;\n    /** Whether to show a link to the create page (on /create subroutes) */\n    create?: boolean;\n  };\n};\n\n/**\n * Internal router with additional props that aren't available in the public API\n * for the old frontend system.\n *\n * @internal\n */\nexport const InternalRouter = (\n  props: PropsWithChildren<\n    RouterProps & { formFieldLoaders?: Array<() => Promise<FormField>> }\n  >,\n) => {\n  const {\n    components: {\n      TemplateCardComponent,\n      TaskPageComponent = OngoingTask,\n      ReviewStepComponent,\n      EXPERIMENTAL_TemplateOutputsComponent: TemplateOutputsComponent,\n      EXPERIMENTAL_TemplateListPageComponent:\n        TemplateListPageComponent = TemplateListPage,\n      EXPERIMENTAL_TemplateWizardPageComponent:\n        TemplateWizardPageComponent = TemplateWizardPage,\n    } = {},\n  } = props;\n  const outlet = useOutlet() || props.children;\n  const customFieldExtensions = useCustomFieldExtensions(outlet);\n  const loadedFieldExtensions = useFormFieldLoaders(props.formFieldLoaders);\n\n  const app = useApp();\n  const { NotFoundErrorPage } = app.getComponents();\n\n  const fieldExtensions = [\n    ...customFieldExtensions,\n    ...loadedFieldExtensions,\n    ...DEFAULT_SCAFFOLDER_FIELD_EXTENSIONS.filter(\n      ({ name }) =>\n        !customFieldExtensions.some(\n          customFieldExtension => customFieldExtension.name === name,\n        ),\n    ),\n  ] as FieldExtensionOptions[];\n\n  const customLayouts = useCustomLayouts(outlet);\n\n  return (\n    <Routes>\n      <Route\n        path=\"/\"\n        element={\n          <TemplateListPageComponent\n            TemplateCardComponent={TemplateCardComponent}\n            contextMenu={props.contextMenu}\n            groups={props.groups}\n            templateFilter={props.templateFilter}\n            headerOptions={props.headerOptions}\n          />\n        }\n      />\n      <Route\n        path={selectedTemplateRouteRef.path}\n        element={\n          <SecretsContextProvider>\n            <TemplateWizardPageComponent\n              headerOptions={props.headerOptions}\n              customFieldExtensions={fieldExtensions}\n              layouts={customLayouts}\n              components={{ ReviewStepComponent }}\n              formProps={props.formProps}\n            />\n          </SecretsContextProvider>\n        }\n      />\n      <Route\n        path={scaffolderTaskRouteRef.path}\n        element={\n          <RequirePermission permission={taskReadPermission}>\n            <TaskPageComponent\n              TemplateOutputsComponent={TemplateOutputsComponent}\n            />\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={editRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateIntroPage />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={customFieldsRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <CustomFieldsPage fieldExtensions={fieldExtensions} />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={templateFormRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateFormPage\n                layouts={customLayouts}\n                formProps={props.formProps}\n                fieldExtensions={fieldExtensions}\n              />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n\n      <Route\n        path={actionsRouteRef.path}\n        element={<ActionsPage contextMenu={props.contextMenu} />}\n      />\n      <Route\n        path={scaffolderListTaskRouteRef.path}\n        element={\n          <RequirePermission permission={taskReadPermission}>\n            <ListTasksPage contextMenu={props.contextMenu} />\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={editorRouteRef.path}\n        element={\n          <RequirePermission permission={templateManagementPermission}>\n            <SecretsContextProvider>\n              <TemplateEditorPage\n                layouts={customLayouts}\n                formProps={props.formProps}\n                fieldExtensions={fieldExtensions}\n              />\n            </SecretsContextProvider>\n          </RequirePermission>\n        }\n      />\n      <Route\n        path={templatingExtensionsRouteRef.path}\n        element={<TemplatingExtensionsPage />}\n      />\n      <Route path=\"*\" element={<NotFoundErrorPage />} />\n    </Routes>\n  );\n};\n\n/**\n * The Scaffolder Router\n *\n * @public\n */\nexport const Router = (props: PropsWithChildren<RouterProps>) => {\n  return <InternalRouter {...props} />;\n};\n\nfunction useFormFieldLoaders(\n  formFieldLoaders?: Array<() => Promise<FormField>>,\n) {\n  const [{ result: loadedFieldExtensions }, { execute }] =\n    useAsync(async () => {\n      const loaded = await Promise.all(\n        (formFieldLoaders ?? []).map(loader => loader()),\n      );\n      return loaded.map(f => OpaqueFormField.toInternal(f));\n    }, []);\n  useMountEffect(execute);\n  return loadedFieldExtensions;\n}\n"],"names":[],"mappings":"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"}