{"version":3,"file":"createRouter.cjs.js","sources":["../../src/service/createRouter.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AuditorService,\n  AuthService,\n  HttpAuthService,\n  LoggerService,\n  PermissionsService,\n  SchedulerService,\n} from '@backstage/backend-plugin-api';\nimport {\n  ANNOTATION_LOCATION,\n  ANNOTATION_ORIGIN_LOCATION,\n  Entity,\n  parseLocationRef,\n  stringifyEntityRef,\n} from '@backstage/catalog-model';\nimport { Config } from '@backstage/config';\nimport { InputError, serializeError } from '@backstage/errors';\nimport { LocationAnalyzer } from '@backstage/plugin-catalog-node';\nimport express from 'express';\nimport yn from 'yn';\nimport { z } from 'zod';\nimport { Cursor, EntitiesCatalog } from '../catalog/types';\nimport { CatalogProcessingOrchestrator } from '../processing/types';\nimport { validateEntityEnvelope } from '../processing/util';\nimport { createOpenApiRouter } from '../schema/openapi';\nimport { AuthorizedValidationService } from './AuthorizedValidationService';\nimport {\n  basicEntityFilter,\n  entitiesBatchRequest,\n  parseEntityFilterParams,\n  parseEntityTransformParams,\n  parseQueryEntitiesParams,\n} from './request';\nimport { parseEntityFacetParams } from './request/parseEntityFacetParams';\nimport { parseEntityOrderParams } from './request/parseEntityOrderParams';\nimport { parseEntityPaginationParams } from './request/parseEntityPaginationParams';\nimport {\n  createEntityArrayJsonStream,\n  writeEntitiesResponse,\n  writeSingleEntityResponse,\n} from './response';\nimport { LocationService, RefreshService } from './types';\nimport {\n  disallowReadonlyMode,\n  encodeCursor,\n  locationInput,\n  validateRequestBody,\n} from './util';\n\n/**\n * Options used by {@link createRouter}.\n */\nexport interface RouterOptions {\n  entitiesCatalog?: EntitiesCatalog;\n  locationAnalyzer?: LocationAnalyzer;\n  locationService: LocationService;\n  orchestrator?: CatalogProcessingOrchestrator;\n  refreshService?: RefreshService;\n  scheduler?: SchedulerService;\n  logger: LoggerService;\n  config: Config;\n  permissionIntegrationRouter?: express.Router;\n  auth: AuthService;\n  httpAuth: HttpAuthService;\n  permissionsService: PermissionsService;\n  // TODO: Require AuditorService once `backend-legacy` is removed\n  auditor?: AuditorService;\n  disableRelationsCompatibility?: boolean;\n}\n\n/**\n * Creates a catalog router.\n */\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const router = await createOpenApiRouter({\n    validatorOptions: {\n      // We want the spec to be up to date with the expected value, but the return type needs\n      //  to be controlled by the router implementation not the request validator.\n      ignorePaths: /^\\/validate-entity\\/?$/,\n    },\n  });\n  const {\n    entitiesCatalog,\n    locationAnalyzer,\n    locationService,\n    orchestrator,\n    refreshService,\n    config,\n    logger,\n    permissionIntegrationRouter,\n    permissionsService,\n    auth,\n    httpAuth,\n    auditor,\n    disableRelationsCompatibility = false,\n  } = options;\n\n  const readonlyEnabled =\n    config.getOptionalBoolean('catalog.readonly') || false;\n  if (readonlyEnabled) {\n    logger.info('Catalog is running in readonly mode');\n  }\n\n  if (refreshService) {\n    // TODO: Potentially find a way to track the ancestor that gets refreshed to refresh this entity (as well as the child of that ancestor?)\n    router.post('/refresh', async (req, res) => {\n      const { authorizationToken, ...restBody } = req.body;\n\n      const auditorEvent = await auditor?.createEvent({\n        eventId: 'entity-mutate',\n        severityLevel: 'medium',\n        meta: {\n          queryType: 'refresh',\n          entityRef: restBody.entityRef,\n        },\n        request: req,\n      });\n\n      try {\n        const credentials = authorizationToken\n          ? await auth.authenticate(authorizationToken)\n          : await httpAuth.credentials(req);\n\n        await refreshService.refresh({\n          ...restBody,\n          credentials,\n        });\n\n        await auditorEvent?.success();\n        res.status(200).end();\n      } catch (err) {\n        await auditorEvent?.fail({ error: err });\n        throw err;\n      }\n    });\n  }\n\n  if (permissionIntegrationRouter) {\n    router.use(permissionIntegrationRouter);\n  }\n\n  if (entitiesCatalog) {\n    router\n      .get('/entities', async (req, res) => {\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-fetch',\n          request: req,\n          meta: {\n            queryType: 'all',\n            query: req.query,\n          },\n        });\n\n        try {\n          const filter = parseEntityFilterParams(req.query);\n          const fields = parseEntityTransformParams(req.query);\n          const order = parseEntityOrderParams(req.query);\n          const pagination = parseEntityPaginationParams(req.query);\n          const credentials = await httpAuth.credentials(req);\n\n          // When pagination parameters are passed in, use the legacy slow path\n          // that loads all entities into memory\n\n          if (pagination || disableRelationsCompatibility !== true) {\n            const { entities, pageInfo } = await entitiesCatalog.entities({\n              filter,\n              fields,\n              order,\n              pagination,\n              credentials,\n            });\n\n            // Add a Link header to the next page\n            if (pageInfo.hasNextPage) {\n              const url = new URL(`http://ignored${req.url}`);\n              url.searchParams.delete('offset');\n              url.searchParams.set('after', pageInfo.endCursor);\n              res.setHeader(\n                'link',\n                `<${url.pathname}${url.search}>; rel=\"next\"`,\n              );\n            }\n\n            await auditorEvent?.success();\n\n            await writeEntitiesResponse({\n              res,\n              items: entities,\n              alwaysUseObjectMode: !disableRelationsCompatibility,\n            });\n            return;\n          }\n\n          const responseStream = createEntityArrayJsonStream(res);\n          const limit = 10000;\n          let cursor: Cursor | undefined;\n\n          try {\n            let currentWrite: Promise<boolean> | undefined = undefined;\n            do {\n              const result = await entitiesCatalog.queryEntities(\n                !cursor\n                  ? {\n                      credentials,\n                      fields,\n                      limit,\n                      filter,\n                      orderFields: order,\n                      skipTotalItems: true,\n                    }\n                  : { credentials, fields, limit, cursor },\n              );\n\n              // Wait for previous write to complete\n              if (await currentWrite) {\n                return; // Client closed connection\n              }\n\n              if (result.items.entities.length) {\n                currentWrite = responseStream.send(result.items);\n              }\n\n              cursor = result.pageInfo?.nextCursor;\n            } while (cursor);\n\n            // Wait for last write to complete\n            await currentWrite;\n\n            await auditorEvent?.success();\n\n            responseStream.complete();\n          } finally {\n            responseStream.close();\n          }\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get('/entities/by-query', async (req, res) => {\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-query',\n          },\n        });\n\n        try {\n          const { items, pageInfo, totalItems } =\n            await entitiesCatalog.queryEntities({\n              limit: req.query.limit,\n              offset: req.query.offset,\n              ...parseQueryEntitiesParams(req.query),\n              credentials: await httpAuth.credentials(req),\n            });\n\n          const meta = {\n            totalItems,\n            pageInfo: {\n              ...(pageInfo.nextCursor && {\n                nextCursor: encodeCursor(pageInfo.nextCursor),\n              }),\n              ...(pageInfo.prevCursor && {\n                prevCursor: encodeCursor(pageInfo.prevCursor),\n              }),\n            },\n          };\n\n          await auditorEvent?.success({\n            // Let's not log out the entities since this can make the log very big\n            meta,\n          });\n\n          await writeEntitiesResponse({\n            res,\n            items,\n            alwaysUseObjectMode: !disableRelationsCompatibility,\n            responseWrapper: entities => ({\n              items: entities,\n              ...meta,\n            }),\n          });\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get('/entities/by-uid/:uid', async (req, res) => {\n        const { uid } = req.params;\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-uid',\n            uid: uid,\n          },\n        });\n\n        try {\n          const { entities } = await entitiesCatalog.entities({\n            filter: basicEntityFilter({ 'metadata.uid': uid }),\n            credentials: await httpAuth.credentials(req),\n          });\n\n          writeSingleEntityResponse(res, entities, `No entity with uid ${uid}`);\n\n          await auditorEvent?.success({\n            meta: {\n              // stringify to entity refs\n              entities: entities.entities.reduce((arr, element) => {\n                if (!element) {\n                  return arr;\n                }\n\n                if (typeof element === 'string') {\n                  arr.push(element);\n                  return arr;\n                }\n\n                arr.push(stringifyEntityRef(element));\n                return arr;\n              }, [] as string[]),\n            },\n          });\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .delete('/entities/by-uid/:uid', async (req, res) => {\n        const { uid } = req.params;\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-mutate',\n          severityLevel: 'medium',\n          request: req,\n          meta: {\n            actionType: 'delete',\n            uid: uid,\n          },\n        });\n\n        try {\n          await entitiesCatalog.removeEntityByUid(uid, {\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success();\n\n          res.status(204).end();\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get('/entities/by-name/:kind/:namespace/:name', async (req, res) => {\n        const { kind, namespace, name } = req.params;\n        const entityRef = stringifyEntityRef({ kind, namespace, name });\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-name',\n            entityRef: entityRef,\n          },\n        });\n\n        try {\n          const { items } = await entitiesCatalog.entitiesBatch({\n            entityRefs: [stringifyEntityRef({ kind, namespace, name })],\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success();\n\n          writeSingleEntityResponse(\n            res,\n            items,\n            `No entity named '${name}' found, with kind '${kind}' in namespace '${namespace}'`,\n          );\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get(\n        '/entities/by-name/:kind/:namespace/:name/ancestry',\n        async (req, res) => {\n          const { kind, namespace, name } = req.params;\n          const entityRef = stringifyEntityRef({ kind, namespace, name });\n\n          const auditorEvent = await auditor?.createEvent({\n            eventId: 'entity-fetch',\n            request: req,\n            meta: {\n              actionType: 'ancestry',\n              entityRef: entityRef,\n            },\n          });\n\n          try {\n            const response = await entitiesCatalog.entityAncestry(entityRef, {\n              credentials: await httpAuth.credentials(req),\n            });\n\n            await auditorEvent?.success({\n              meta: {\n                rootEntityRef: response.rootEntityRef,\n                ancestry: response.items.map(ancestryLink => {\n                  return {\n                    entityRef: stringifyEntityRef(ancestryLink.entity),\n                    parentEntityRefs: ancestryLink.parentEntityRefs,\n                  };\n                }),\n              },\n            });\n\n            res.status(200).json(response);\n          } catch (err) {\n            await auditorEvent?.fail({\n              error: err,\n            });\n            throw err;\n          }\n        },\n      )\n      .post('/entities/by-refs', async (req, res) => {\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-refs',\n          },\n        });\n\n        try {\n          const request = entitiesBatchRequest(req);\n          const { items } = await entitiesCatalog.entitiesBatch({\n            entityRefs: request.entityRefs,\n            filter: parseEntityFilterParams(req.query),\n            fields: parseEntityTransformParams(req.query, request.fields),\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success({\n            meta: {\n              ...request,\n            },\n          });\n\n          await writeEntitiesResponse({\n            res,\n            items,\n            alwaysUseObjectMode: !disableRelationsCompatibility,\n            responseWrapper: entities => ({\n              items: entities,\n            }),\n          });\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get('/entity-facets', async (req, res) => {\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'entity-facets',\n          request: req,\n        });\n\n        try {\n          const response = await entitiesCatalog.facets({\n            filter: parseEntityFilterParams(req.query),\n            facets: parseEntityFacetParams(req.query),\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success();\n\n          res.status(200).json(response);\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      });\n  }\n\n  if (locationService) {\n    router\n      .post('/locations', async (req, res) => {\n        const location = await validateRequestBody(req, locationInput);\n        const dryRun = yn(req.query.dryRun, { default: false });\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'location-mutate',\n          severityLevel: dryRun ? 'low' : 'medium',\n          request: req,\n          meta: {\n            actionType: 'create',\n            location: location,\n            isDryRun: dryRun,\n          },\n        });\n\n        try {\n          // when in dryRun addLocation is effectively a read operation so we don't\n          // need to disallow readonly\n          if (!dryRun) {\n            disallowReadonlyMode(readonlyEnabled);\n          }\n\n          const output = await locationService.createLocation(\n            location,\n            dryRun,\n            {\n              credentials: await httpAuth.credentials(req),\n            },\n          );\n\n          await auditorEvent?.success({\n            meta: {\n              location: output.location,\n            },\n          });\n\n          res.status(201).json(output);\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n            meta: {\n              location: location,\n              isDryRun: dryRun,\n            },\n          });\n          throw err;\n        }\n      })\n      .get('/locations', async (req, res) => {\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'location-fetch',\n          request: req,\n          meta: {\n            queryType: 'all',\n          },\n        });\n\n        try {\n          const locations = await locationService.listLocations({\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success();\n\n          res.status(200).json(locations.map(l => ({ data: l })));\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n\n      .get('/locations/:id', async (req, res) => {\n        const { id } = req.params;\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'location-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-id',\n            id: id,\n          },\n        });\n\n        try {\n          const output = await locationService.getLocation(id, {\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success({\n            meta: {\n              output: output,\n            },\n          });\n\n          res.status(200).json(output);\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .delete('/locations/:id', async (req, res) => {\n        const { id } = req.params;\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'location-mutate',\n          severityLevel: 'medium',\n          request: req,\n          meta: {\n            actionType: 'delete',\n            id: id,\n          },\n        });\n\n        disallowReadonlyMode(readonlyEnabled);\n\n        try {\n          await locationService.deleteLocation(id, {\n            credentials: await httpAuth.credentials(req),\n          });\n\n          await auditorEvent?.success();\n\n          res.status(204).end();\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      })\n      .get('/locations/by-entity/:kind/:namespace/:name', async (req, res) => {\n        const { kind, namespace, name } = req.params;\n        const locationRef = `${kind}:${namespace}/${name}`;\n\n        const auditorEvent = await auditor?.createEvent({\n          eventId: 'location-fetch',\n          request: req,\n          meta: {\n            queryType: 'by-entity',\n            locationRef: locationRef,\n          },\n        });\n\n        try {\n          const output = await locationService.getLocationByEntity(\n            { kind, namespace, name },\n            { credentials: await httpAuth.credentials(req) },\n          );\n\n          await auditorEvent?.success({\n            meta: {\n              output: output,\n            },\n          });\n\n          res.status(200).json(output);\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n          throw err;\n        }\n      });\n  }\n\n  if (locationAnalyzer) {\n    router.post('/analyze-location', async (req, res) => {\n      const auditorEvent = await auditor?.createEvent({\n        eventId: 'location-analyze',\n        request: req,\n      });\n\n      try {\n        const body = await validateRequestBody(\n          req,\n          z.object({\n            location: locationInput,\n            catalogFilename: z.string().optional(),\n          }),\n        );\n        const schema = z.object({\n          location: locationInput,\n          catalogFilename: z.string().optional(),\n        });\n        const credentials = await httpAuth.credentials(req);\n        const parsedBody = schema.parse(body);\n        try {\n          const output = await locationAnalyzer.analyzeLocation(\n            parsedBody,\n            credentials,\n          );\n\n          await auditorEvent?.success({\n            meta: {\n              output: output,\n            },\n          });\n\n          res.status(200).json(output);\n        } catch (err) {\n          if (\n            // Catch errors from parse-url library.\n            err.name === 'Error' &&\n            'subject_url' in err\n          ) {\n            throw new InputError('The given location.target is not a URL');\n          }\n          throw err;\n        }\n      } catch (err) {\n        await auditorEvent?.fail({\n          error: err,\n        });\n        throw err;\n      }\n    });\n  }\n\n  if (orchestrator) {\n    router.post('/validate-entity', async (req, res) => {\n      const auditorEvent = await auditor?.createEvent({\n        eventId: 'entity-validate',\n        request: req,\n      });\n\n      try {\n        const bodySchema = z.object({\n          entity: z.unknown(),\n          location: z.string(),\n        });\n\n        let body: z.infer<typeof bodySchema>;\n        let entity: Entity;\n        let location: { type: string; target: string };\n        try {\n          body = await validateRequestBody(req, bodySchema);\n          entity = validateEntityEnvelope(body.entity);\n          location = parseLocationRef(body.location);\n          if (location.type !== 'url')\n            throw new TypeError(\n              `Invalid location ref ${body.location}, only 'url:<target>' is supported, e.g. url:https://host/path`,\n            );\n        } catch (err) {\n          await auditorEvent?.fail({\n            error: err,\n          });\n\n          return res.status(400).json({\n            errors: [serializeError(err)],\n          });\n        }\n\n        const credentials = await httpAuth.credentials(req);\n        const authorizedValidationService = new AuthorizedValidationService(\n          orchestrator,\n          permissionsService,\n        );\n        const processingResult = await authorizedValidationService.process(\n          {\n            entity: {\n              ...entity,\n              metadata: {\n                ...entity.metadata,\n                annotations: {\n                  [ANNOTATION_LOCATION]: body.location,\n                  [ANNOTATION_ORIGIN_LOCATION]: body.location,\n                  ...entity.metadata.annotations,\n                },\n              },\n            },\n          },\n          credentials,\n        );\n\n        if (!processingResult.ok) {\n          const errors = processingResult.errors.map(e => serializeError(e));\n\n          await auditorEvent?.fail({\n            // TODO(Rugvip): Seems like there aren't proper types for AggregateError yet\n            error: (AggregateError as any)(errors, 'Could not validate entity'),\n          });\n\n          res.status(400).json({\n            errors,\n          });\n        }\n\n        await auditorEvent?.success();\n\n        return res.status(200).end();\n      } catch (err) {\n        await auditorEvent?.fail({\n          error: err,\n        });\n        throw err;\n      }\n    });\n  }\n\n  return router;\n}\n"],"names":["router","createOpenApiRouter","parseEntityFilterParams","parseEntityTransformParams","parseEntityOrderParams","parseEntityPaginationParams","writeEntitiesResponse","createEntityArrayJsonStream","parseQueryEntitiesParams","encodeCursor","basicEntityFilter","writeSingleEntityResponse","stringifyEntityRef","entitiesBatchRequest","parseEntityFacetParams","validateRequestBody","locationInput","yn","disallowReadonlyMode","z","InputError","validateEntityEnvelope","parseLocationRef","serializeError","AuthorizedValidationService","ANNOTATION_LOCATION","ANNOTATION_ORIGIN_LOCATION","errors"],"mappings":"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"}